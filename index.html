<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>ğŸŒ™ æœˆçƒç”Ÿå­˜å¤§æŒ‘æˆ°ï¼</title>
  <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@400;600;700;900&display=swap" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/sortablejs@latest/Sortable.min.js"></script>
  <style>
    :root {
      --space-dark: #0f0c29;
      --space-mid: #302b63;
      --space-light: #24243e;
      --moon-yellow: #ffd93d;
      --rocket-red: #ff6b6b;
      --star-blue: #4ecdc4;
      --alien-green: #6bcb77;
      --cosmic-purple: #a855f7;
      --warning-orange: #ff9f43;
      --white: #ffffff;
    }

    * { margin: 0; padding: 0; box-sizing: border-box; }

    body {
      font-family: 'Noto Sans TC', sans-serif;
      background: linear-gradient(135deg, var(--space-dark) 0%, var(--space-mid) 50%, var(--space-light) 100%);
      min-height: 100vh;
      min-height: 100dvh;
      color: var(--white);
      overflow-x: hidden;
    }

    .stars {
      position: fixed;
      top: 0; left: 0;
      width: 100%; height: 100%;
      pointer-events: none;
      z-index: 0;
    }

    .star {
      position: absolute;
      background: white;
      border-radius: 50%;
      animation: twinkle 2s infinite ease-in-out;
    }

    @keyframes twinkle {
      0%, 100% { opacity: 0.3; transform: scale(1); }
      50% { opacity: 1; transform: scale(1.2); }
    }

    .container {
      position: relative;
      z-index: 1;
      max-width: 600px;
      margin: 0 auto;
      padding: 15px;
      min-height: 100vh;
      min-height: 100dvh;
      display: flex;
      flex-direction: column;
    }

    header {
      text-align: center;
      padding: 15px 0;
    }

    h1 {
      font-weight: 900;
      font-size: clamp(1.4rem, 5vw, 2rem);
      background: linear-gradient(90deg, var(--moon-yellow), var(--rocket-red), var(--cosmic-purple));
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-clip: text;
    }

    .subtitle {
      color: var(--star-blue);
      margin-top: 5px;
      font-size: 0.9rem;
    }

    .screen {
      display: none;
      flex: 1;
      flex-direction: column;
    }

    .screen.active {
      display: flex;
      animation: fadeIn 0.4s ease;
    }

    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(15px); }
      to { opacity: 1; transform: translateY(0); }
    }

    .story-box {
      background: linear-gradient(145deg, rgba(255,255,255,0.1), rgba(255,255,255,0.05));
      border: 2px solid var(--star-blue);
      border-radius: 18px;
      padding: 18px;
      margin-bottom: 15px;
    }

    .story-box h2 {
      color: var(--moon-yellow);
      font-size: 1.1rem;
      margin-bottom: 10px;
    }

    .story-box p {
      line-height: 1.7;
      font-size: 0.95rem;
    }

    .instructions {
      background: rgba(168, 85, 247, 0.2);
      border: 2px dashed var(--cosmic-purple);
      border-radius: 12px;
      padding: 12px;
      text-align: center;
      margin-bottom: 12px;
      font-size: 0.9rem;
    }

    .btn {
      font-family: 'Noto Sans TC', sans-serif;
      font-weight: 700;
      font-size: 1rem;
      padding: 14px 28px;
      border: none;
      border-radius: 25px;
      cursor: pointer;
      transition: all 0.2s ease;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      gap: 8px;
    }

    .btn-primary {
      background: linear-gradient(135deg, var(--alien-green), var(--star-blue));
      color: var(--space-dark);
    }

    .btn-primary:hover { transform: translateY(-2px) scale(1.02); }

    .btn-secondary {
      background: linear-gradient(135deg, var(--moon-yellow), var(--rocket-red));
      color: var(--space-dark);
    }

    .btn:disabled { opacity: 0.6; cursor: not-allowed; }

    .center-btn {
      display: flex;
      justify-content: center;
      padding: 12px 0;
    }

    .items-list {
      flex: 1;
      overflow-y: auto;
      padding: 5px 0;
    }

    .item {
      display: flex;
      align-items: center;
      gap: 10px;
      background: linear-gradient(145deg, rgba(255,255,255,0.12), rgba(255,255,255,0.05));
      border: 2px solid rgba(255,255,255,0.15);
      border-radius: 10px;
      padding: 10px;
      margin-bottom: 6px;
      transition: all 0.2s ease;
      user-select: none;
    }

    .item:hover { border-color: var(--moon-yellow); }

    .item:active {
      transform: scale(1.02);
      border-color: var(--star-blue);
      box-shadow: 0 0 20px rgba(78, 205, 196, 0.4);
    }

    .item.sortable-ghost {
      opacity: 0.4;
      background: rgba(168, 85, 247, 0.3);
      border-color: var(--cosmic-purple);
    }

    .item.sortable-chosen {
      transform: scale(1.05);
      border-color: var(--moon-yellow);
      box-shadow: 0 8px 25px rgba(255, 217, 61, 0.4);
      z-index: 100;
    }

    .item.sortable-drag {
      opacity: 1;
      background: linear-gradient(145deg, rgba(78, 205, 196, 0.3), rgba(168, 85, 247, 0.2));
      border-color: var(--star-blue);
    }

    .item-rank {
      width: 28px; height: 28px;
      background: linear-gradient(135deg, var(--rocket-red), var(--cosmic-purple));
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      font-weight: 900;
      font-size: 0.85rem;
      flex-shrink: 0;
    }

    .item-emoji { font-size: 1.4rem; width: 35px; text-align: center; }
    .item-name { font-weight: 600; font-size: 0.9rem; flex: 1; }

    .item-drag-handle {
      font-size: 1.3rem;
      color: rgba(255,255,255,0.6);
      cursor: grab;
      padding: 5px;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    .item-drag-handle:active {
      cursor: grabbing;
    }

    .chat-container {
      flex: 1;
      display: flex;
      flex-direction: column;
      overflow: hidden;
    }

    .messages {
      flex: 1;
      overflow-y: auto;
      padding: 8px 0;
      display: flex;
      flex-direction: column;
      gap: 8px;
    }

    .message {
      max-width: 90%;
      padding: 12px 14px;
      border-radius: 16px;
      animation: messageIn 0.3s ease;
      line-height: 1.6;
    }

    @keyframes messageIn {
      from { opacity: 0; transform: translateY(10px) scale(0.95); }
      to { opacity: 1; transform: translateY(0) scale(1); }
    }

    .message.bot {
      align-self: flex-start;
      background: linear-gradient(145deg, rgba(168, 85, 247, 0.3), rgba(78, 205, 196, 0.2));
      border: 2px solid var(--cosmic-purple);
      border-bottom-left-radius: 5px;
    }

    .message.user {
      align-self: flex-end;
      background: linear-gradient(135deg, var(--alien-green), var(--star-blue));
      color: var(--space-dark);
      font-weight: 600;
      border-bottom-right-radius: 5px;
    }

    .message.incident {
      background: linear-gradient(145deg, rgba(255, 159, 67, 0.3), rgba(255, 107, 107, 0.2));
      border: 2px solid var(--warning-orange);
      max-width: 95%;
    }

    .message.event-card {
      background: linear-gradient(145deg, rgba(78, 205, 196, 0.2), rgba(168, 85, 247, 0.15));
      border: 3px solid var(--star-blue);
      max-width: 100%;
      padding: 16px;
    }

    .event-card-header {
      display: flex;
      align-items: center;
      gap: 8px;
      margin-bottom: 12px;
    }

    .event-card-badge {
      background: linear-gradient(135deg, var(--star-blue), var(--cosmic-purple));
      color: var(--white);
      padding: 4px 12px;
      border-radius: 12px;
      font-size: 0.75rem;
      font-weight: 700;
    }

    .event-card-title {
      font-weight: 900;
      font-size: 1.1rem;
      color: var(--moon-yellow);
    }

    .event-card-section {
      margin: 12px 0;
      padding: 10px 12px;
      border-radius: 10px;
      background: rgba(255,255,255,0.05);
    }

    .event-card-section-title {
      font-weight: 700;
      font-size: 0.8rem;
      color: var(--star-blue);
      margin-bottom: 6px;
    }

    .event-card-section.situation {
      border-left: 3px solid var(--alien-green);
    }

    .event-card-section.event {
      border-left: 3px solid var(--warning-orange);
      background: rgba(255, 159, 67, 0.1);
    }

    .event-card-section.questions {
      border-left: 3px solid var(--cosmic-purple);
      background: rgba(168, 85, 247, 0.1);
    }

    .event-card-question {
      display: flex;
      gap: 8px;
      margin: 8px 0;
      font-size: 0.9rem;
      line-height: 1.5;
    }

    .event-card-question-num {
      background: var(--cosmic-purple);
      color: var(--white);
      width: 22px;
      height: 22px;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 0.75rem;
      font-weight: 700;
      flex-shrink: 0;
    }

    .message.lesson {
      background: linear-gradient(145deg, rgba(107, 203, 119, 0.3), rgba(78, 205, 196, 0.2));
      border: 2px solid var(--alien-green);
      max-width: 95%;
    }

    .message .sender {
      font-weight: 900;
      color: var(--moon-yellow);
      font-size: 0.75rem;
      margin-bottom: 4px;
    }

    .message.incident .sender { color: var(--warning-orange); }
    .message.lesson .sender { color: var(--alien-green); }

    .message-content { font-size: 0.92rem; }
    .message-content p { margin: 5px 0; }
    .message-content p:first-child { margin-top: 0; }
    .message-content p:last-child { margin-bottom: 0; }
    .message-content strong { color: var(--moon-yellow); }
    .message-content ul { margin: 8px 0; padding-left: 20px; }
    .message-content li { margin: 4px 0; }

    .incident-title {
      font-weight: 900;
      font-size: 1rem;
      color: var(--warning-orange);
      margin-bottom: 8px;
    }

    .item-highlight {
      display: inline-flex;
      align-items: center;
      gap: 4px;
      background: rgba(255, 217, 61, 0.2);
      border: 1px solid var(--moon-yellow);
      border-radius: 8px;
      padding: 4px 10px;
      margin: 3px 2px;
      font-size: 0.85rem;
    }

    .typing-indicator {
      display: flex;
      gap: 4px;
      padding: 5px 0;
    }

    .typing-dot {
      width: 7px; height: 7px;
      background: var(--moon-yellow);
      border-radius: 50%;
      animation: typingBounce 1.4s ease-in-out infinite;
    }

    .typing-dot:nth-child(2) { animation-delay: 0.2s; }
    .typing-dot:nth-child(3) { animation-delay: 0.4s; }

    @keyframes typingBounce {
      0%, 60%, 100% { transform: translateY(0); }
      30% { transform: translateY(-6px); }
    }

    .quick-replies {
      display: flex;
      flex-wrap: wrap;
      gap: 6px;
      padding: 10px 0;
      justify-content: center;
    }

    .quick-reply {
      font-family: 'Noto Sans TC', sans-serif;
      font-size: 0.85rem;
      font-weight: 600;
      padding: 9px 14px;
      border: 2px solid var(--star-blue);
      border-radius: 18px;
      background: rgba(78, 205, 196, 0.2);
      color: var(--white);
      cursor: pointer;
      transition: all 0.2s ease;
    }

    .quick-reply:hover {
      background: var(--star-blue);
      color: var(--space-dark);
    }

    .quick-reply.choice-btn {
      width: 100%;
      text-align: left;
      padding: 12px 16px;
      display: flex;
      align-items: center;
      gap: 10px;
      font-size: 0.9rem;
      background: linear-gradient(145deg, rgba(255,255,255,0.08), rgba(255,255,255,0.03));
      border-color: var(--cosmic-purple);
    }

    .quick-reply.choice-btn:hover {
      background: linear-gradient(135deg, var(--cosmic-purple), var(--star-blue));
      border-color: var(--moon-yellow);
    }

    .choice-letter {
      background: var(--cosmic-purple);
      color: var(--white);
      width: 24px;
      height: 24px;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      font-weight: 700;
      font-size: 0.8rem;
      flex-shrink: 0;
    }

    .choice-emoji {
      font-size: 1.3rem;
    }

    .quick-reply.primary {
      background: linear-gradient(135deg, var(--alien-green), var(--star-blue));
      border-color: var(--alien-green);
      color: var(--space-dark);
    }

    .quick-reply.warning {
      background: linear-gradient(135deg, var(--warning-orange), var(--rocket-red));
      border-color: var(--warning-orange);
      color: var(--space-dark);
    }

    .quick-reply.correct {
      background: linear-gradient(135deg, var(--alien-green), #22c55e);
      border-color: var(--alien-green);
      color: var(--space-dark);
    }

    .quick-reply.wrong {
      background: rgba(255, 107, 107, 0.3);
      border-color: var(--rocket-red);
      color: var(--white);
    }

    .quick-reply.item-choice {
      background: linear-gradient(145deg, rgba(255,255,255,0.12), rgba(255,255,255,0.05));
      border-color: var(--cosmic-purple);
      display: flex;
      align-items: center;
      gap: 6px;
      font-size: 0.9rem;
      padding: 10px 16px;
    }

    .quick-reply.item-choice:hover {
      background: var(--cosmic-purple);
      border-color: var(--moon-yellow);
    }

    .quick-reply.item-choice .item-emoji-btn {
      font-size: 1.2rem;
    }

    .choice-header {
      width: 100%;
      text-align: center;
      font-size: 0.85rem;
      color: var(--star-blue);
      margin-bottom: 6px;
      font-weight: 600;
    }

    .home-btn {
      position: fixed;
      top: 15px;
      left: 15px;
      z-index: 100;
      font-family: 'Noto Sans TC', sans-serif;
      font-size: 0.8rem;
      font-weight: 600;
      padding: 8px 14px;
      border: 2px solid var(--star-blue);
      border-radius: 20px;
      background: rgba(78, 205, 196, 0.2);
      color: var(--white);
      cursor: pointer;
      transition: all 0.2s ease;
      display: flex;
      align-items: center;
      gap: 5px;
    }

    .home-btn:hover {
      background: var(--star-blue);
      color: var(--space-dark);
    }

    footer {
      text-align: center;
      padding: 15px 0;
      font-size: 0.75rem;
      color: rgba(255,255,255,0.5);
      border-top: 1px solid rgba(255,255,255,0.1);
      margin-top: 15px;
    }

    footer strong {
      color: var(--star-blue);
    }

    .score-card {
      background: linear-gradient(145deg, rgba(107, 203, 119, 0.3), rgba(78, 205, 196, 0.2));
      border: 3px solid var(--alien-green);
      border-radius: 16px;
      padding: 16px;
      margin: 8px 0;
      text-align: center;
    }

    .score-number {
      font-weight: 900;
      font-size: 2.5rem;
      background: linear-gradient(90deg, var(--moon-yellow), var(--alien-green));
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-clip: text;
    }

    .score-label { color: var(--star-blue); font-weight: 600; font-size: 0.9rem; }

    .badge {
      display: inline-block;
      padding: 6px 16px;
      border-radius: 15px;
      font-weight: 900;
      font-size: 0.95rem;
      margin-top: 8px;
    }

    .badge.gold { background: linear-gradient(135deg, #ffd700, #ffb700); color: #333; }
    .badge.silver { background: linear-gradient(135deg, #c0c0c0, #a0a0a0); color: #333; }
    .badge.bronze { background: linear-gradient(135deg, #cd7f32, #b87333); color: white; }

    .results-table {
      width: 100%;
      margin: 10px 0;
      border-collapse: collapse;
      font-size: 0.8rem;
    }

    .results-table th {
      background: var(--cosmic-purple);
      padding: 6px 4px;
      text-align: center;
    }

    .results-table td {
      padding: 5px 4px;
      text-align: center;
      border-bottom: 1px solid rgba(255,255,255,0.1);
    }

    .results-table tr:nth-child(even) { background: rgba(255,255,255,0.05); }

    .diff-good { color: var(--alien-green); font-weight: 700; }
    .diff-ok { color: var(--moon-yellow); font-weight: 700; }
    .diff-bad { color: var(--rocket-red); font-weight: 700; }

    .progress-bar {
      background: rgba(255,255,255,0.1);
      border-radius: 10px;
      height: 8px;
      margin: 10px 0;
      overflow: hidden;
    }

    .progress-fill {
      height: 100%;
      background: linear-gradient(90deg, var(--alien-green), var(--star-blue));
      border-radius: 10px;
      transition: width 0.5s ease;
    }

    .feedback-correct {
      background: linear-gradient(145deg, rgba(107, 203, 119, 0.4), rgba(34, 197, 94, 0.3));
      border: 2px solid var(--alien-green);
    }

    .feedback-wrong {
      background: linear-gradient(145deg, rgba(255, 107, 107, 0.3), rgba(239, 68, 68, 0.2));
      border: 2px solid var(--rocket-red);
    }

    .dark body {
      background: linear-gradient(135deg, #000 0%, #1a1a2e 50%, #16213e 100%);
    }

    @media (max-width: 400px) {
      .item { padding: 8px; }
      .item-emoji { font-size: 1.2rem; width: 30px; }
      .item-name { font-size: 0.85rem; }
      .results-table { font-size: 0.75rem; }
      .quick-reply.item-choice { padding: 8px 12px; font-size: 0.85rem; }
    }
  </style>
</head>
<body>
  <div class="stars" id="stars"></div>

  <button class="home-btn" id="home-btn" onclick="goHome()" style="display:none">ğŸ  è¿”å›ä¸»é </button>

  <div class="container">
    <header>
      <h1>ğŸŒ™ æœˆçƒç”Ÿå­˜å¤§æŒ‘æˆ°</h1>
      <p class="subtitle">çœ‹çœ‹ä½ æ˜¯å¦æ‡‚å¾—åœ¨æœˆçƒä¸Šç”Ÿå­˜ï¼</p>
    </header>

    <div id="intro-screen" class="screen active">
      <div class="story-box">
        <h2>ğŸ‘¨â€ğŸš€ ä½ çš„å¤ªç©ºå†’éšªï¼</h2>
        <p>
          å¤§äº‹ä¸å¥½ï¼ä½ çš„å¤ªç©ºèˆ¹åœ¨æœˆçƒå¢œæ¯€äº†ï¼ğŸš€ğŸ’¥<br><br>
          ä½ éœ€è¦æ­¥è¡Œ <strong>300 å…¬é‡Œ</strong>æ‰èƒ½åˆ°é”æœˆçƒåŸºåœ°ï¼<br><br>
          ä½ æ‰¾åˆ°äº† <strong>15 ä»¶ç‰©å“</strong>ï¼Œå¿…é ˆæ±ºå®šå“ªäº›æœ€é‡è¦ï¼<br><br>
          ä¹‹å¾Œæœƒæœ‰ <strong>5 å¼µäº‹ä»¶å¡</strong>ï¼Œå¹«åŠ©ä½ æ€è€ƒæœˆçƒç”Ÿå­˜çš„å•é¡Œï¼ğŸŒŸ
        </p>
      </div>

      <div class="instructions">
        <p>ğŸ‘† <strong>æ‹–æ‹‰ç‰©å“æ’åˆ—é †åºï¼</strong></p>
        <p>ğŸ† #1 = æœ€é‡è¦ â†’ #15 = æœ€ä¸é‡è¦</p>
      </div>

      <div class="center-btn">
        <button class="btn btn-primary" onclick="startRanking()">ğŸš€ é–‹å§‹æŒ‘æˆ°ï¼</button>
      </div>
    </div>

    <div id="ranking-screen" class="screen">
      <div class="instructions">
        <p>ğŸ‘† æŒ‰ä½ä¸¦æ‹–æ‹‰ç‰©å“ä¾†æ’åˆ—é †åºï¼ #1 = æœ€é‡è¦</p>
      </div>
      <div class="items-list" id="items-list"></div>
      <div class="center-btn">
        <button class="btn btn-secondary" onclick="submitRankings()">âœ… äº¤å·é–‹å§‹å†’éšªï¼</button>
      </div>
    </div>

    <div id="chat-screen" class="screen">
      <div class="chat-container">
        <div class="messages" id="messages"></div>
        <div class="quick-replies" id="quick-replies"></div>
      </div>
    </div>

    <footer>
      <p>Created by <strong>Cheung Chung Wah Joyce</strong></p>
      <p>MEDD8869 Moon Survival Game (Primary Edition)</p>
    </footer>
  </div>

  <script>
    const items = [
      { id: 1, emoji: "ğŸ’¨", name: "æ°§æ°£ç½", nasaRank: 1, reason: "æœˆçƒæ²’æœ‰ç©ºæ°£ï¼Œé€™æ˜¯ç”Ÿå­˜å¿…éœ€å“ï¼æ²’æœ‰æ°§æ°£å¹¾åˆ†é˜å°±æœƒæ­»äº¡ï¼" },
      { id: 2, emoji: "ğŸ’§", name: "é£Ÿæ°´", nasaRank: 2, reason: "äººé«”éœ€è¦æ°´ä¾†ç¶­æŒç”Ÿå‘½ï¼Œæœˆçƒæ²’æœ‰æ°´æºï¼Œæ‰€ä»¥å¿…é ˆæ”œå¸¶é£Ÿæ°´ï¼" },
      { id: 3, emoji: "ğŸ—ºï¸", name: "æ˜Ÿéš›åœ°åœ–", nasaRank: 3, reason: "æœˆçƒæ²’æœ‰ GPSï¼Œéœ€è¦é æ˜Ÿæ˜Ÿä¾†è¾¨èªæ–¹å‘ï¼åœ°åœ–å¯ä»¥å¹«åŠ©ä½ æ‰¾åˆ°æ­£ç¢ºè·¯ç·šï¼" },
      { id: 4, emoji: "ğŸ«", name: "æ¿ƒç¸®é£Ÿç‰©", nasaRank: 4, reason: "æ­¥è¡Œ 300 å…¬é‡Œéœ€è¦å¤§é‡èƒ½é‡ï¼Œæ¿ƒç¸®é£Ÿç‰©é«”ç©å°ä½†ç‡Ÿé¤Šè±å¯Œï¼" },
      { id: 5, emoji: "ğŸ“»", name: "å¤ªé™½èƒ½æ”¶éŸ³æ©Ÿ", nasaRank: 5, reason: "å¯ä»¥èˆ‡æœˆçƒåŸºåœ°è¯çµ¡ï¼Œè«‹æ±‚æ•‘æ´ï¼" },
      { id: 6, emoji: "ğŸª¢", name: "å°¼é¾ç¹©", nasaRank: 6, reason: "å¯ä»¥ç¶ä½éšŠå‹ä¸€èµ·è¡Œèµ°ï¼Œé€šéå±éšªåœ°å¸¶æ™‚äº’ç›¸å¹«åŠ©ï¼" },
      { id: 7, emoji: "ğŸ©¹", name: "æ€¥æ•‘ç®±", nasaRank: 7, reason: "å—å‚·æ™‚å¯ä»¥åŒ…ç´®å‚·å£ï¼Œé‚„æœ‰ä¿®è£œå¤ªç©ºè¡£çš„ææ–™ï¼" },
      { id: 8, emoji: "ğŸª‚", name: "é™è½å‚˜å¸ƒ", nasaRank: 8, reason: "å¯ä»¥é®æ“‹å¤ªé™½ã€é˜»æ“‹ç°å¡µã€æ¬é‹ç‰©å“ï¼Œç”¨é€”å»£æ³›ï¼" },
      { id: 9, emoji: "ğŸ›Ÿ", name: "æ•‘ç”Ÿè‰‡", nasaRank: 9, reason: "å¯ä»¥ç”¨ä¾†è£è¼‰ç‰©å“ã€é®è“‹ç‰©è³‡ï¼Œç”šè‡³å¯ä»¥åå°„é™½å…‰æ±‚æ•‘ï¼" },
      { id: 10, emoji: "ğŸ“¡", name: "ä¿¡è™Ÿå½ˆ", nasaRank: 10, reason: "æ¥è¿‘åŸºåœ°æ™‚å¯ä»¥ç™¼å°„ä¿¡è™Ÿï¼Œè®“äººçŸ¥é“ä½ çš„ä½ç½®ï¼" },
      { id: 11, emoji: "ğŸ§¯", name: "æ»…ç«ç­’", nasaRank: 11, reason: "å¯ä»¥ç•¶ä½œå™´å°„æ¨é€²å™¨ä½¿ç”¨ï¼å™´å‡ºçš„æ°£é«”å¯ä»¥æ¨å‹•ä½ å‰é€²ï¼" },
      { id: 12, emoji: "ğŸ¥›", name: "è„«æ°´å¥¶", nasaRank: 12, reason: "æœ‰ç‡Ÿé¤Šä½†éœ€è¦åŠ æ°´ï¼Œæ²’æœ‰æ°´å°±æ²’ä»€éº¼ç”¨è™•ï¼" },
      { id: 13, emoji: "ğŸ”†", name: "å¤ªé™½èƒ½æš–çˆ", nasaRank: 13, reason: "å¤ªç©ºè¡£å·²ç¶“æœ‰ä¿æš–åŠŸèƒ½ï¼Œè€Œä¸”åœ¨é™°å½±å€æ²’æœ‰å¤ªé™½èƒ½ï¼" },
      { id: 14, emoji: "ğŸ§­", name: "æŒ‡å—é‡", nasaRank: 14, reason: "æœˆçƒæ²’æœ‰ç£å ´ï¼ŒæŒ‡å—é‡å®Œå…¨ç„¡æ³•ä½¿ç”¨ï¼" },
      { id: 15, emoji: "ğŸ”¥", name: "ç«æŸ´", nasaRank: 15, reason: "æœˆçƒæ²’æœ‰æ°§æ°£ï¼Œç«æŸ´ç„¡è«–å¦‚ä½•éƒ½é»ä¸è‘—ï¼" },
      { id: 16, emoji: "ğŸ”¦", name: "æ‰‹é›»ç­’", nasaRank: 16, reason: "æœˆçƒé™°å½±å€å¯ä»¥ä½¿ç”¨ï¼Œä½†é›»æ± åœ¨æ¥µç«¯æº«åº¦ä¸‹å¯èƒ½å¤±æ•ˆï¼" }
    ];

    // äº‹ä»¶å¡ - æœƒéš¨æ©Ÿæ’åº
    const eventCards = [
      {
        id: 1,
        title: "ğŸ§­ æˆ‘å€‘è¿·è·¯äº†ï¼",
        situation: "ä½ çš„å°éšŠéœ€è¦åœ¨æœˆçƒè¡¨é¢æ‰¾å‡ºå‰å¾€æ¯èˆ¹çš„æ­£ç¢ºæ–¹å‘ï¼Œä½†æŒ‡å—é‡å®Œå…¨ç„¡æ³•é‹ä½œã€‚",
        event: "æŒ‡å—é‡çš„æŒ‡é‡ä¸åœè½‰å‹•ï¼Œå®Œå…¨ç„¡æ³•æŒ‡å‡ºæ–¹å‘ï¼",
        questions: [
          "å¦‚æœåœ¨åœ°çƒçš„æ£®æ—è¿·è·¯ï¼Œä½ æœƒé¸å“ªä¸€é …å·¥å…·ï¼Ÿç‚ºç”šéº¼ï¼Ÿ",
          "ç‚ºç”šéº¼åŒä¸€ä»¶å·¥å…·åœ¨ä¸åŒåœ°æ–¹ï¼Œæ•ˆæœæœƒä¸åŒï¼Ÿ",
          "è‹¥å¤©è‰²æ˜æš—ï¼Œæ˜Ÿåœ–ä¸æ¸…æ¥šï¼Œä½ é‚„å¯ä»¥æ€æ¨£å”åŠ©éšŠä¼ï¼Ÿ"
        ],
        itemQuestion: "ä½ èªç‚ºæ‡‰è©²ä½¿ç”¨å“ªä¸€é …å·¥å…·ä¾†è¾¨åˆ¥æ–¹å‘ï¼Ÿ",
        correctItem: "æ˜Ÿéš›åœ°åœ–",
        wrongItems: ["æŒ‡å—é‡", "æ‰‹é›»ç­’"],
        explanation: "ğŸ—ºï¸ **æ­£ç¢ºç­”æ¡ˆï¼šæ˜Ÿåœ–ï¼ˆæ˜Ÿéš›åœ°åœ–ï¼‰ï¼**\n\næœˆçƒä¸Šæ²’æœ‰ç£å ´ï¼ŒæŒ‡å—é‡ä¸èƒ½ä½¿ç”¨ï¼›æ˜Ÿé«”ä½ç½®å›ºå®šï¼Œæœ‰åŠ©è¾¨åˆ¥æ–¹å‘ã€‚\n\né€™å°±æ˜¯ç‚ºä»€éº¼ NASA æŠŠæ˜Ÿéš›åœ°åœ–æ’åœ¨ç¬¬ 3 ä½ï¼åœ¨æœˆçƒä¸Šï¼Œæˆ‘å€‘éœ€è¦é è§€å¯Ÿæ˜Ÿæ˜Ÿçš„ä½ç½®ä¾†æ‰¾åˆ°æ­£ç¢ºæ–¹å‘ã€‚"
      },
      {
        id: 2,
        title: "ğŸ˜° éšŠå“¡æ„Ÿåˆ°ä¸é©",
        situation: "æœ‰éšŠå“¡å‡ºç¾å‘¼å¸æ€¥ä¿ƒåŠç–²å€¦çš„æƒ…æ³ï¼Œè¡Œå‹•é–‹å§‹è®Šæ…¢ã€‚",
        event: "éšŠå“¡çš„è‡‰è‰²è®Šå¾—è’¼ç™½ï¼Œå‘¼å¸è¶Šä¾†è¶Šå›°é›£ï¼",
        questions: [
          "é£Ÿç‰©ã€æ°´ã€æ°§æ°£ä¹‹ä¸­ï¼Œå“ªä¸€æ¨£æœ€å…ˆéœ€è¦ï¼Ÿè«‹æ’åºä¸¦è§£é‡‹ã€‚",
          "ç‚ºç”šéº¼æœ‰äº›è³‡æºæ˜¯ã€Œå¿…éœ€å“ã€ï¼Œè€Œä¸æ˜¯ã€Œæœ‰ç”¨å°±å¥½ã€ï¼Ÿ",
          "å¦‚æœæ°§æ°£æœ‰é™ï¼Œä½ æœƒå¦‚ä½•ä½œå‡ºå…¬å¹³åˆ†é…ï¼Ÿ"
        ],
        itemQuestion: "ä½ èªç‚ºæ­¤æ™‚æœ€éœ€è¦ä½¿ç”¨å“ªä¸€é …å·¥å…·ï¼Ÿ",
        correctItem: "æ°§æ°£ç½",
        wrongItems: ["æ¿ƒç¸®é£Ÿç‰©", "é£Ÿæ°´"],
        explanation: "ğŸ’¨ **æ­£ç¢ºç­”æ¡ˆï¼šæ°§æ°£ç“¶ï¼ˆæ°§æ°£ç½ï¼‰ï¼**\n\næ²’æœ‰æ°§æ°£ï¼Œäººé¡ç„¡æ³•åœ¨æœˆçƒä¸Šç”Ÿå­˜ï¼\n\näººé¡æ²’æœ‰æ°§æ°£åªèƒ½ç”Ÿå­˜**å¹¾åˆ†é˜**ï¼Œä½†æ²’æœ‰é£Ÿç‰©å¯ä»¥ç”Ÿå­˜å¹¾å¤©ï¼Œæ²’æœ‰æ°´å¯ä»¥ç”Ÿå­˜å¹¾å°æ™‚ã€‚\n\næ‰€ä»¥ NASA æŠŠæ°§æ°£æ’åœ¨ç¬¬ 1 ä½ï¼Œé€™æ˜¯æœ€åŸºæœ¬çš„ç”Ÿå­˜éœ€æ±‚ï¼"
      },
      {
        id: 3,
        title: "ğŸ—ºï¸ è·¯ç·šå‡ºç¾å›°é›£",
        situation: "å‰æ–¹åœ°å½¢å´å¶‡ï¼Œè·¯ç·šä¸æ¸…æ¥šï¼Œå°éšŠæ“”å¿ƒæœƒåé›¢æ–¹å‘ã€‚",
        event: "ä½ å€‘ç«™åœ¨ä¸€å€‹åˆ†å²”è·¯å£ï¼Œä¸çŸ¥é“è©²å¾€å“ªå€‹æ–¹å‘èµ°ï¼",
        questions: [
          "å°¼é¾ç¹©åœ¨ç”šéº¼æƒ…æ³ä¸‹æ‰æœƒæ¯”æ˜Ÿåœ–æ›´æœ‰ç”¨ï¼Ÿ",
          "ç•¶è·¯ç·šä¸æ¸…æ¥šæ™‚ï¼Œæ‡‰è©²ã€Œç¹¼çºŒå‰é€²ã€é‚„æ˜¯ã€Œå…ˆç¢ºèªæ–¹å‘ã€ï¼Ÿ",
          "å¦‚æœéšŠå“¡æ„è¦‹ä¸åŒï¼Œä½ æœƒæ€æ¨£å”åŠ©å°çµ„ä½œæ±ºå®šï¼Ÿ"
        ],
        itemQuestion: "ä½ èªç‚ºæ‡‰è©²ä½¿ç”¨å“ªä¸€é …å·¥å…·ï¼Ÿ",
        correctItem: "æ˜Ÿéš›åœ°åœ–",
        wrongItems: ["å°¼é¾ç¹©", "æ€¥æ•‘ç®±"],
        explanation: "ğŸ—ºï¸ **æ­£ç¢ºç­”æ¡ˆï¼šæ˜Ÿåœ–ï¼ˆæ˜Ÿéš›åœ°åœ–ï¼‰ï¼**\n\næ˜Ÿåœ–å¯å”åŠ©ç¢ºèªä½ç½®èˆ‡æ–¹å‘ï¼Œé¿å…è¿·è·¯ã€‚\n\nç•¶è·¯ç·šä¸æ¸…æ¥šæ™‚ï¼Œæ‡‰è©²**å…ˆç¢ºèªæ–¹å‘**å†å‰é€²ï¼Œè€Œä¸æ˜¯ç›²ç›®å¾€å‰èµ°ï¼\n\nå°¼é¾ç¹©åœ¨æ”€çˆ¬æˆ–ç¶ä½éšŠå“¡æ™‚æ›´æœ‰ç”¨ï¼Œä½†æ‰¾æ–¹å‘é‚„æ˜¯è¦é æ˜Ÿåœ–ï¼"
      },
      {
        id: 4,
        title: "ğŸ©¹ éšŠå“¡å—å‚·äº†",
        situation: "ä¸€åéšŠå“¡åœ¨è¡Œèµ°æ™‚è·Œå€’ï¼Œæ‰‹éƒ¨æ“¦å‚·ï¼Œå½±éŸ¿è¡Œå‹•ã€‚",
        event: "éšŠå“¡çš„æ‰‹åœ¨æµè¡€ï¼Œéœ€è¦ç«‹å³è™•ç†å‚·å£ï¼",
        questions: [
          "ç‚ºç”šéº¼å…ˆç…§é¡§å—å‚·éšŠå“¡å°æ•´å€‹å°éšŠéƒ½å¾ˆé‡è¦ï¼Ÿ",
          "å¦‚æœå—å‚·çš„éšŠå“¡æ˜¯éšŠé•·ï¼Œä½ æœƒå¦‚ä½•èª¿æ•´åˆ†å·¥ï¼Ÿ",
          "é™¤äº†å·¥å…·ï¼Œä½ èªç‚ºé‚„éœ€è¦ç”šéº¼æ‰èƒ½ä¿éšœå®‰å…¨ï¼Ÿ"
        ],
        itemQuestion: "ä½ èªç‚ºæ‡‰ç«‹å³ä½¿ç”¨å“ªä¸€é …å·¥å…·ï¼Ÿ",
        correctItem: "æ€¥æ•‘ç®±",
        wrongItems: ["é£Ÿæ°´", "æ‰‹é›»ç­’"],
        explanation: "ğŸ©¹ **æ­£ç¢ºç­”æ¡ˆï¼šæ€¥æ•‘åŒ…ï¼ˆæ€¥æ•‘ç®±ï¼‰ï¼**\n\næ€¥æ•‘åŒ…å¯å³æ™‚è™•ç†å‚·å£ï¼Œç¢ºä¿éšŠå“¡å®‰å…¨ã€‚\n\nç…§é¡§å—å‚·éšŠå“¡å°æ•´å€‹å°éšŠéƒ½å¾ˆé‡è¦ï¼Œå› ç‚ºï¼š\n1. å‚·å£å¯èƒ½æƒ¡åŒ–å½±éŸ¿è¡Œå‹•\n2. åœ˜éšŠéœ€è¦æ¯å€‹æˆå“¡çš„åŠ›é‡\n3. äº’ç›¸ç…§é¡§èƒ½æå‡åœ˜éšŠå£«æ°£ï¼"
      },
      {
        id: 5,
        title: "ğŸ“» éœ€è¦è®“æ¯èˆ¹çŸ¥é“æˆ‘å€‘çš„ä½ç½®",
        situation: "ä½ å€‘ç›¸ä¿¡å·²æ¥è¿‘æ¯èˆ¹ï¼Œä½†éœ€è¦ç™¼å‡ºè¨Šè™Ÿè®“å°æ–¹çŸ¥é“ä½ å€‘çš„ä½ç½®ã€‚",
        event: "é è™•ä¼¼ä¹çœ‹åˆ°æ¯èˆ¹çš„å½±å­ï¼Œä½†å°æ–¹å¥½åƒä¸çŸ¥é“ä½ å€‘åœ¨å“ªè£¡ï¼",
        questions: [
          "å¦‚æœæ”¶éŸ³æ©Ÿçªç„¶ç„¡æ³•ä½¿ç”¨ï¼Œä½ é‚„å¯ä»¥æ€æ¨£è®“å°æ–¹æ‰¾åˆ°ä½ ï¼Ÿ",
          "ç‚ºç”šéº¼ã€Œæºé€šã€åœ¨è§£é›£éç¨‹ä¸­ååˆ†é‡è¦ï¼Ÿ",
          "å¦‚æœåªèƒ½ç™¼å‡ºä¸€æ¬¡è¨Šè™Ÿï¼Œä½ æœƒå‚³é”å“ªäº›æœ€é‡è¦çš„è³‡è¨Šï¼Ÿ"
        ],
        itemQuestion: "ä½ èªç‚ºæœ€åˆé©ä½¿ç”¨å“ªä¸€é …å·¥å…·ï¼Ÿ",
        correctItem: "å¤ªé™½èƒ½æ”¶éŸ³æ©Ÿ",
        wrongItems: ["æ˜Ÿéš›åœ°åœ–", "æ¿ƒç¸®é£Ÿç‰©"],
        explanation: "ğŸ“» **æ­£ç¢ºç­”æ¡ˆï¼šå¤ªé™½èƒ½æ”¶éŸ³æ©Ÿï¼**\n\næ”¶éŸ³æ©Ÿå¯ç”¨ä½œé€šè¨Šï¼Œå”åŠ©æ¯èˆ¹æ¥æ”¶è¨Šè™Ÿä¸¦å®‰æ’æ•‘æ´ã€‚\n\næºé€šåœ¨è§£é›£éç¨‹ä¸­éå¸¸é‡è¦ï¼Œå› ç‚ºï¼š\n1. è®“å°æ–¹çŸ¥é“ä½ çš„ä½ç½®\n2. å¯ä»¥å”èª¿æ•‘æ´è¡Œå‹•\n3. æ¸›å°‘èª¤è§£å’ŒéŒ¯èª¤ï¼\n\nå¦‚æœåªèƒ½ç™¼ä¸€æ¬¡è¨Šè™Ÿï¼Œæœ€é‡è¦æ˜¯èªªæ˜**ä½ç½®**å’Œ**äººæ•¸**ï¼"
      }
    ];

    let shuffledEvents = []; // å„²å­˜éš¨æ©Ÿæ’åºå¾Œçš„äº‹ä»¶å¡

    let playerRanking = [];
    let currentIncidentIndex = 0;
    let gamePhase = 'intro';
    let isProcessing = false;

    if (window.matchMedia?.('(prefers-color-scheme: dark)').matches) {
      document.documentElement.classList.add('dark');
    }
    window.matchMedia('(prefers-color-scheme: dark)').addEventListener('change', e => {
      document.documentElement.classList.toggle('dark', e.matches);
    });

    function createStars() {
      const container = document.getElementById('stars');
      for (let i = 0; i < 80; i++) {
        const star = document.createElement('div');
        star.className = 'star';
        star.style.cssText = `left:${Math.random()*100}%;top:${Math.random()*100}%;width:${Math.random()*3+1}px;height:${star.style.width};animation-delay:${Math.random()*2}s;`;
        container.appendChild(star);
      }
    }

    function shuffleArray(arr) {
      const a = [...arr];
      for (let i = a.length - 1; i > 0; i--) {
        const j = Math.floor(Math.random() * (i + 1));
        [a[i], a[j]] = [a[j], a[i]];
      }
      return a;
    }

    function showScreen(id) {
      document.querySelectorAll('.screen').forEach(s => s.classList.remove('active'));
      document.getElementById(id).classList.add('active');

      // Show/hide home button
      const homeBtn = document.getElementById('home-btn');
      if (id === 'intro-screen') {
        homeBtn.style.display = 'none';
      } else {
        homeBtn.style.display = 'flex';
      }
    }

    function goHome() {
      location.reload();
    }

    function startRanking() {
      playerRanking = shuffleArray([...items]);
      renderItems();
      showScreen('ranking-screen');
      gamePhase = 'ranking';
    }

    let sortable = null;

    function renderItems() {
      const c = document.getElementById('items-list');
      c.innerHTML = '';
      playerRanking.forEach((item, i) => {
        const el = document.createElement('div');
        el.className = 'item';
        el.dataset.id = item.id;

        el.innerHTML = `
          <div class="item-rank">${i+1}</div>
          <div class="item-emoji">${item.emoji}</div>
          <div class="item-name">${item.name}</div>
          <div class="item-drag-handle">â˜°</div>
        `;

        c.appendChild(el);
      });

      // Initialize SortableJS for easy drag-and-drop
      if (sortable) {
        sortable.destroy();
      }

      sortable = new Sortable(c, {
        animation: 200,
        easing: "cubic-bezier(0.25, 1, 0.5, 1)",
        ghostClass: 'sortable-ghost',
        chosenClass: 'sortable-chosen',
        dragClass: 'sortable-drag',
        handle: '.item', // Allow dragging from anywhere on the item
        delay: 100, // Small delay to prevent accidental drags
        delayOnTouchOnly: true, // Only apply delay on touch devices
        touchStartThreshold: 5, // Pixels to move before drag starts on touch
        forceFallback: true, // Better cross-browser support
        fallbackTolerance: 3,
        onEnd: function(evt) {
          // Update playerRanking array after drag ends
          const movedItem = playerRanking.splice(evt.oldIndex, 1)[0];
          playerRanking.splice(evt.newIndex, 0, movedItem);

          // Update rank numbers
          updateRankNumbers();
        }
      });
    }

    function updateRankNumbers() {
      const items = document.querySelectorAll('#items-list .item');
      items.forEach((item, i) => {
        const rankEl = item.querySelector('.item-rank');
        if (rankEl) {
          rankEl.textContent = i + 1;
        }
      });
    }

    function addMsg(content, type = 'bot', isHTML = false) {
      const m = document.getElementById('messages');
      const msg = document.createElement('div');
      msg.className = `message ${type}`;
      const sender = type === 'incident' ? 'âš ï¸ çªç™¼äº‹ä»¶' : type === 'lesson' ? 'ğŸ“š å­¸ç¿’é‡é»' : 'ğŸ¤– å¤ªç©ºåšå£«';
      if (type !== 'user') {
        msg.innerHTML = `<div class="sender">${sender}</div><div class="message-content">${isHTML ? content : marked.parse(content)}</div>`;
      } else {
        msg.innerHTML = `<div class="message-content">${content}</div>`;
      }
      m.appendChild(msg);
      m.scrollTop = m.scrollHeight;
    }

    function showTyping() {
      const m = document.getElementById('messages');
      const t = document.createElement('div');
      t.className = 'message bot';
      t.id = 'typing';
      t.innerHTML = `<div class="sender">ğŸ¤– å¤ªç©ºåšå£«</div><div class="typing-indicator"><div class="typing-dot"></div><div class="typing-dot"></div><div class="typing-dot"></div></div>`;
      m.appendChild(t);
      m.scrollTop = m.scrollHeight;
    }

    function hideTyping() { document.getElementById('typing')?.remove(); }

    function setReplies(replies) {
      const c = document.getElementById('quick-replies');
      c.innerHTML = '';
      replies.forEach(r => {
        const btn = document.createElement('button');
        btn.className = `quick-reply ${r.className || ''} ${r.primary ? 'primary' : ''} ${r.warning ? 'warning' : ''}`;
        btn.innerHTML = r.html || r.text;
        btn.onclick = () => handleReply(r.value);
        c.appendChild(btn);
      });
    }

    function clearReplies() { document.getElementById('quick-replies').innerHTML = ''; }

    async function botSay(msg, isHTML = false, delay = 600) {
      showTyping();
      await new Promise(r => setTimeout(r, delay));
      hideTyping();
      addMsg(msg, 'bot', isHTML);
    }

    async function submitRankings() {
      showScreen('chat-screen');
      gamePhase = 'incidents';
      currentIncidentIndex = 0;

      // éš¨æ©Ÿæ’åºäº‹ä»¶å¡
      shuffledEvents = shuffleArray([...eventCards]);

      await botSay("ğŸ‰ **å·²æ”¶åˆ°ä½ çš„æ’åï¼**\n\nç¾åœ¨é–‹å§‹æœˆçƒå†’éšªä¹‹æ—…... ä½ æœƒé‡åˆ° 5 å¼µäº‹ä»¶å¡ï¼\n\næ¯å¼µå¡éƒ½æœ‰æ€è€ƒå•é¡Œï¼Œå¹«åŠ©ä½ æ›´æ·±å…¥äº†è§£æœˆçƒç”Ÿå­˜çš„æŒ‘æˆ°ï¼ğŸš€");

      await new Promise(r => setTimeout(r, 800));
      await showEventCard(0);
    }

    async function showEventCard(idx) {
      if (idx >= shuffledEvents.length) {
        await showResults();
        return;
      }

      const card = shuffledEvents[idx];
      currentIncidentIndex = idx;

      await new Promise(r => setTimeout(r, 300));
      addEventCard(card, idx + 1);

      await new Promise(r => setTimeout(r, 600));
      await botSay(`**ğŸ¯ ${card.itemQuestion}**`);

      showItemChoices(card);
    }

    function showItemChoices(card) {
      const c = document.getElementById('quick-replies');
      c.innerHTML = '';

      // Build choices array: 1 correct + 2 wrong
      const correctItemData = items.find(i => i.name === card.correctItem);
      const wrongItemsData = card.wrongItems.map(name => items.find(i => i.name === name));

      const allChoices = [
        { ...correctItemData, isCorrect: true },
        ...wrongItemsData.map(item => ({ ...item, isCorrect: false }))
      ];

      // Shuffle the 3 choices
      const shuffledChoices = shuffleArray(allChoices);

      shuffledChoices.forEach((choice, i) => {
        const btn = document.createElement('button');
        btn.className = 'quick-reply choice-btn';
        btn.innerHTML = `<span class="choice-letter">${String.fromCharCode(65 + i)}</span> <span class="choice-emoji">${choice.emoji}</span> ${choice.name}`;
        btn.onclick = () => handleItemAnswer(choice, card);
        c.appendChild(btn);
      });
    }

    async function handleItemAnswer(choice, card) {
      if (isProcessing) return;
      isProcessing = true;
      clearReplies();

      // Show user's choice
      addMsg(`${choice.emoji} ${choice.name}`, 'user');

      await new Promise(r => setTimeout(r, 400));

      if (choice.isCorrect) {
        const feedback = `<div class="feedback-correct" style="padding:12px;border-radius:12px;margin:5px 0">
          <strong>âœ… ç­”å°äº†ï¼å¤ªæ£’äº†ï¼</strong>
        </div>`;
        await botSay(feedback, true);
      } else {
        const feedback = `<div class="feedback-wrong" style="padding:12px;border-radius:12px;margin:5px 0">
          <strong>âŒ ä¸å¤ªå°å–”ï¼</strong>
        </div>`;
        await botSay(feedback, true);
      }

      await new Promise(r => setTimeout(r, 500));
      await botSay(card.explanation);

      await new Promise(r => setTimeout(r, 400));
      showNextBtn();

      isProcessing = false;
    }

    function addEventCard(card, displayNum) {
      const m = document.getElementById('messages');
      const msg = document.createElement('div');
      msg.className = 'message event-card';

      let questionsHTML = '';
      card.questions.forEach((q, i) => {
        questionsHTML += `
          <div class="event-card-question">
            <span class="event-card-question-num">${i + 1}</span>
            <span>${q}</span>
          </div>
        `;
      });

      msg.innerHTML = `
        <div class="event-card-header">
          <span class="event-card-badge">ğŸŸ¦ äº‹ä»¶å¡ ${displayNum}/5</span>
        </div>
        <div class="event-card-title">${card.title}</div>

        <div class="event-card-section situation">
          <div class="event-card-section-title">ğŸ“ æƒ…å¢ƒèªªæ˜</div>
          <div>${card.situation}</div>
        </div>

        <div class="event-card-section event">
          <div class="event-card-section-title">âš¡ çªç™¼äº‹ä»¶</div>
          <div>${card.event}</div>
        </div>

        <div class="event-card-section questions">
          <div class="event-card-section-title">ğŸ¤” æ€è€ƒå•é¡Œ</div>
          ${questionsHTML}
        </div>
      `;

      m.appendChild(msg);
      m.scrollTop = m.scrollHeight;
    }

    async function handleReply(val) {
      if (isProcessing) return;
      isProcessing = true;
      clearReplies();

      if (val === 'next') {
        await showEventCard(currentIncidentIndex + 1);
      } else if (val === 'results') {
        await showResults();
      } else if (val === 'show_nasa') {
        await showNASAAnswer();
      } else if (val === 'restart') {
        location.reload();
      } else if (val.startsWith('explain_')) {
        const rank = parseInt(val.split('_')[1]);
        await explainItem(rank);
      }

      isProcessing = false;
    }

    function showNextBtn() {
      if (currentIncidentIndex < shuffledEvents.length - 1) {
        setReplies([{ text: "â¡ï¸ ä¸‹ä¸€å¼µäº‹ä»¶å¡ï¼", value: "next", primary: true }]);
      } else {
        setReplies([{ text: "ğŸ† æŸ¥çœ‹æœ€çµ‚çµæœï¼", value: "results", primary: true }]);
      }
    }

    async function showResults() {
      gamePhase = 'results';

      await botSay("ğŸŠ **æ­å–œä½ å®Œæˆäº†æ‰€æœ‰äº‹ä»¶å¡ï¼**\n\nç¾åœ¨ä¾†çœ‹çœ‹ä½ çš„æ’åæˆç¸¾...");

      let totalDiff = 0;
      const results = [];
      playerRanking.forEach((item, i) => {
        const pRank = i + 1;
        const diff = Math.abs(pRank - item.nasaRank);
        totalDiff += diff;
        results.push({ ...item, playerRank: pRank, diff });
      });

      let badge, badgeClass;
      if (totalDiff <= 20) { badge = "ğŸ† å¤ªç©ºå°ˆå®¶ï¼"; badgeClass = "gold"; }
      else if (totalDiff <= 40) { badge = "ğŸŒŸ å„ªç§€å¤ªç©ºäººï¼"; badgeClass = "silver"; }
      else { badge = "ğŸš€ å¤ªç©ºæ–°æ‰‹ï¼"; badgeClass = "bronze"; }

      const scoreCard = `<div class="score-card"><div class="score-label">ä½ çš„åˆ†æ•¸</div><div class="score-number">${totalDiff}</div><div style="opacity:0.7;font-size:0.8rem">ï¼ˆåˆ†æ•¸è¶Šä½è¶Šå¥½ï¼0åˆ† = å®Œç¾ï¼ï¼‰</div><div class="badge ${badgeClass}">${badge}</div></div>`;
      await botSay(scoreCard, true, 800);

      let table = `<table class="results-table"><tr><th>ç‰©å“</th><th>ä½ </th><th>NASA</th><th>å·®</th></tr>`;
      results.forEach(item => {
        const dc = item.diff === 0 ? 'diff-good' : item.diff <= 3 ? 'diff-ok' : 'diff-bad';
        table += `<tr><td>${item.emoji} ${item.name}</td><td>${item.playerRank}</td><td>${item.nasaRank}</td><td class="${dc}">${item.diff === 0 ? 'âœ“' : item.diff}</td></tr>`;
      });
      table += '</table>';
      await botSay(table, true, 400);

      // é¡¯ç¤º NASA æ¨™æº–ç­”æ¡ˆæŒ‰éˆ•
      await botSay("**ğŸ“š æƒ³çŸ¥é“ NASA å°ˆå®¶çš„æ¨™æº–æ’åå—ï¼Ÿ**");

      setReplies([
        { text: "ğŸš€ æŸ¥çœ‹ NASA æ¨™æº–ç­”æ¡ˆï¼", value: "show_nasa", primary: true },
        { text: "ğŸ”„ å†ç©ä¸€æ¬¡ï¼", value: "restart" }
      ]);
    }

    async function showNASAAnswer() {
      await botSay("ğŸŒŸ **NASA å°ˆå®¶æ¨™æº–æ’å**\n\nä»¥ä¸‹æ˜¯ NASA å¤ªç©ºå°ˆå®¶æ ¹æ“šæœˆçƒç”Ÿå­˜éœ€æ±‚è€Œåˆ¶å®šçš„å®˜æ–¹æ’åï¼š");

      // ç²å–æ’åºå¾Œçš„ç‰©å“ï¼ˆåªå–å‰15å€‹ï¼Œæ’é™¤æ‰‹é›»ç­’ï¼‰
      const sortedItems = [...items].filter(i => i.nasaRank <= 15).sort((a, b) => a.nasaRank - b.nasaRank);

      let nasaTable = `<div style="background:linear-gradient(145deg, rgba(168,85,247,0.2), rgba(78,205,196,0.15)); border:3px solid var(--cosmic-purple); border-radius:16px; padding:16px; margin:10px 0;">
        <div style="text-align:center; margin-bottom:12px;">
          <span style="font-size:1.5rem;">ğŸ›ï¸</span>
          <strong style="color:var(--moon-yellow); font-size:1.1rem;"> NASA å®˜æ–¹æ¨™æº–ç­”æ¡ˆ</strong>
        </div>
        <table class="results-table" style="margin:0;">
          <tr><th style="width:15%">æ’å</th><th>ç‰©å“</th><th style="width:55%">åŸå› </th></tr>`;

      sortedItems.forEach(item => {
        let rankStyle = '';
        if (item.nasaRank <= 3) {
          rankStyle = 'background:linear-gradient(135deg,#ffd700,#ffb700);color:#333;font-weight:900;';
        } else if (item.nasaRank <= 7) {
          rankStyle = 'background:linear-gradient(135deg,var(--alien-green),var(--star-blue));color:#333;font-weight:700;';
        } else if (item.nasaRank <= 10) {
          rankStyle = 'background:rgba(255,255,255,0.2);';
        } else {
          rankStyle = 'background:rgba(255,107,107,0.2);';
        }

        nasaTable += `<tr>
          <td style="${rankStyle};border-radius:8px;"><strong>#${item.nasaRank}</strong></td>
          <td><span style="font-size:1.2rem;">${item.emoji}</span> ${item.name}</td>
          <td style="text-align:left;font-size:0.75rem;line-height:1.4;">${item.reason}</td>
        </tr>`;
      });

      nasaTable += `</table></div>`;
      await botSay(nasaTable, true, 600);

      // ç¸½çµé‡é»
      await botSay(`**ğŸ“ å­¸ç¿’é‡é»ç¸½çµï¼š**

**ğŸ¥‡ æœ€é‡è¦ï¼ˆç¬¬1-5åï¼‰ï¼š**
- **æ°§æ°£** - æ²’æœ‰ç©ºæ°£ï¼Œå¹¾åˆ†é˜å°±æœƒæ­»äº¡ï¼
- **é£Ÿæ°´** - äººé«”éœ€è¦æ°´ä¾†ç¶­æŒç”Ÿå‘½
- **æ˜Ÿéš›åœ°åœ–** - æœˆçƒæ²’æœ‰GPSï¼Œé æ˜Ÿæ˜Ÿè¾¨èªæ–¹å‘
- **æ¿ƒç¸®é£Ÿç‰©** - æ­¥è¡Œ300å…¬é‡Œéœ€è¦èƒ½é‡
- **æ”¶éŸ³æ©Ÿ** - å¯ä»¥èˆ‡åŸºåœ°è¯çµ¡æ±‚æ•‘

**ğŸ¥ˆ æœ‰ç”¨ï¼ˆç¬¬6-10åï¼‰ï¼š**
- å°¼é¾ç¹©ã€æ€¥æ•‘ç®±ã€é™è½å‚˜å¸ƒã€æ•‘ç”Ÿè‰‡ã€ä¿¡è™Ÿå½ˆ

**ğŸ¥‰ ä¸å¤ªæœ‰ç”¨ï¼ˆç¬¬11-15åï¼‰ï¼š**
- **æ»…ç«ç­’** - åªèƒ½ç•¶æ¨é€²å™¨ç”¨
- **è„«æ°´å¥¶** - æ²’æ°´å°±æ²’ç”¨
- **å¤ªé™½èƒ½æš–çˆ** - å¤ªç©ºè¡£å·²ä¿æš–
- **æŒ‡å—é‡** - æœˆçƒæ²’ç£å ´ï¼Œç„¡æ³•ä½¿ç”¨ï¼
- **ç«æŸ´** - æœˆçƒæ²’æ°§æ°£ï¼Œé»ä¸è‘—ï¼`);

      await new Promise(r => setTimeout(r, 500));

      setReplies([
        { text: "ğŸ’¨ äº†è§£æ›´å¤šï¼šæ°§æ°£", value: "explain_1" },
        { text: "ğŸ§­ äº†è§£æ›´å¤šï¼šæŒ‡å—é‡", value: "explain_14" },
        { text: "ğŸ”¥ äº†è§£æ›´å¤šï¼šç«æŸ´", value: "explain_15" },
        { text: "ğŸ”„ å†ç©ä¸€æ¬¡ï¼", value: "restart", primary: true }
      ]);
    }

    async function explainItem(rank) {
      const item = items.find(i => i.nasaRank === rank);
      if (item) {
        await botSay(`**${item.emoji} ${item.name} (NASA æ’ç¬¬ ${item.nasaRank})**\n\n${item.reason}`);
      }
      setReplies([
        { text: "ğŸ’¨ æ°§æ°£", value: "explain_1" },
        { text: "ğŸ’§ é£Ÿæ°´", value: "explain_2" },
        { text: "ğŸ—ºï¸ åœ°åœ–", value: "explain_3" },
        { text: "ğŸ§­ æŒ‡å—é‡", value: "explain_14" },
        { text: "ğŸ”¥ ç«æŸ´", value: "explain_15" },
        { text: "ğŸ”„ å†ç©ä¸€æ¬¡ï¼", value: "restart", primary: true }
      ]);
    }

    createStars();
  </script>
</body>
</html>
