<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>ğŸŒ™ æœˆçƒç”Ÿå­˜å¤§æŒ‘æˆ°ï¼</title>
  <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@400;600;700;900&display=swap" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/sortablejs@latest/Sortable.min.js"></script>
  <style>
    :root {
      --space-dark: #0f0c29;
      --space-mid: #302b63;
      --space-light: #24243e;
      --moon-yellow: #ffd93d;
      --rocket-red: #ff6b6b;
      --star-blue: #4ecdc4;
      --alien-green: #6bcb77;
      --cosmic-purple: #a855f7;
      --warning-orange: #ff9f43;
      --white: #ffffff;
    }

    * { margin: 0; padding: 0; box-sizing: border-box; }

    body {
      font-family: 'Noto Sans TC', sans-serif;
      background: linear-gradient(135deg, var(--space-dark) 0%, var(--space-mid) 50%, var(--space-light) 100%);
      min-height: 100vh;
      min-height: 100dvh;
      color: var(--white);
      overflow-x: hidden;
    }

    .stars {
      position: fixed;
      top: 0; left: 0;
      width: 100%; height: 100%;
      pointer-events: none;
      z-index: 0;
    }

    .star {
      position: absolute;
      background: white;
      border-radius: 50%;
      animation: twinkle 2s infinite ease-in-out;
    }

    @keyframes twinkle {
      0%, 100% { opacity: 0.3; transform: scale(1); }
      50% { opacity: 1; transform: scale(1.2); }
    }

    .container {
      position: relative;
      z-index: 1;
      max-width: 600px;
      margin: 0 auto;
      padding: 15px;
      min-height: 100vh;
      min-height: 100dvh;
      display: flex;
      flex-direction: column;
    }

    header {
      text-align: center;
      padding: 15px 0;
    }

    h1 {
      font-weight: 900;
      font-size: clamp(1.4rem, 5vw, 2rem);
      background: linear-gradient(90deg, var(--moon-yellow), var(--rocket-red), var(--cosmic-purple));
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-clip: text;
    }

    .subtitle {
      color: var(--star-blue);
      margin-top: 5px;
      font-size: 0.9rem;
    }

    .screen {
      display: none;
      flex: 1;
      flex-direction: column;
    }

    .screen.active {
      display: flex;
      animation: fadeIn 0.4s ease;
    }

    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(15px); }
      to { opacity: 1; transform: translateY(0); }
    }

    .story-box {
      background: linear-gradient(145deg, rgba(255,255,255,0.1), rgba(255,255,255,0.05));
      border: 2px solid var(--star-blue);
      border-radius: 18px;
      padding: 18px;
      margin-bottom: 15px;
    }

    .story-box h2 {
      color: var(--moon-yellow);
      font-size: 1.1rem;
      margin-bottom: 10px;
    }

    .story-box p {
      line-height: 1.7;
      font-size: 0.95rem;
    }

    .instructions {
      background: rgba(168, 85, 247, 0.2);
      border: 2px dashed var(--cosmic-purple);
      border-radius: 12px;
      padding: 12px;
      text-align: center;
      margin-bottom: 12px;
      font-size: 0.9rem;
    }

    .btn {
      font-family: 'Noto Sans TC', sans-serif;
      font-weight: 700;
      font-size: 1rem;
      padding: 14px 28px;
      border: none;
      border-radius: 25px;
      cursor: pointer;
      transition: all 0.2s ease;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      gap: 8px;
    }

    .btn-primary {
      background: linear-gradient(135deg, var(--alien-green), var(--star-blue));
      color: var(--space-dark);
    }

    .btn-primary:hover { transform: translateY(-2px) scale(1.02); }

    .btn-secondary {
      background: linear-gradient(135deg, var(--moon-yellow), var(--rocket-red));
      color: var(--space-dark);
    }

    .btn:disabled { opacity: 0.6; cursor: not-allowed; }

    .center-btn {
      display: flex;
      justify-content: center;
      padding: 12px 0;
    }

    .items-list {
      flex: 1;
      overflow-y: auto;
      padding: 5px 0;
    }

    .item {
      display: flex;
      align-items: center;
      gap: 10px;
      background: linear-gradient(145deg, rgba(255,255,255,0.12), rgba(255,255,255,0.05));
      border: 2px solid rgba(255,255,255,0.15);
      border-radius: 10px;
      padding: 10px;
      margin-bottom: 6px;
      transition: all 0.2s ease;
      user-select: none;
    }

    .item:hover { border-color: var(--moon-yellow); }

    .item:active {
      transform: scale(1.02);
      border-color: var(--star-blue);
      box-shadow: 0 0 20px rgba(78, 205, 196, 0.4);
    }

    .item.sortable-ghost {
      opacity: 0.4;
      background: rgba(168, 85, 247, 0.3);
      border-color: var(--cosmic-purple);
    }

    .item.sortable-chosen {
      transform: scale(1.05);
      border-color: var(--moon-yellow);
      box-shadow: 0 8px 25px rgba(255, 217, 61, 0.4);
      z-index: 100;
    }

    .item.sortable-drag {
      opacity: 1;
      background: linear-gradient(145deg, rgba(78, 205, 196, 0.3), rgba(168, 85, 247, 0.2));
      border-color: var(--star-blue);
    }

    .item-rank {
      width: 28px; height: 28px;
      background: linear-gradient(135deg, var(--rocket-red), var(--cosmic-purple));
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      font-weight: 900;
      font-size: 0.85rem;
      flex-shrink: 0;
    }

    .item-emoji { font-size: 1.4rem; width: 35px; text-align: center; }
    .item-name { font-weight: 600; font-size: 0.9rem; flex: 1; }

    .item-drag-handle {
      font-size: 1.3rem;
      color: rgba(255,255,255,0.6);
      cursor: grab;
      padding: 5px;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    .item-drag-handle:active {
      cursor: grabbing;
    }

    .chat-container {
      flex: 1;
      display: flex;
      flex-direction: column;
      overflow: hidden;
    }

    .messages {
      flex: 1;
      overflow-y: auto;
      padding: 8px 0;
      display: flex;
      flex-direction: column;
      gap: 8px;
    }

    .message {
      max-width: 90%;
      padding: 12px 14px;
      border-radius: 16px;
      animation: messageIn 0.3s ease;
      line-height: 1.6;
    }

    @keyframes messageIn {
      from { opacity: 0; transform: translateY(10px) scale(0.95); }
      to { opacity: 1; transform: translateY(0) scale(1); }
    }

    .message.bot {
      align-self: flex-start;
      background: linear-gradient(145deg, rgba(168, 85, 247, 0.3), rgba(78, 205, 196, 0.2));
      border: 2px solid var(--cosmic-purple);
      border-bottom-left-radius: 5px;
    }

    .message.user {
      align-self: flex-end;
      background: linear-gradient(135deg, var(--alien-green), var(--star-blue));
      color: var(--space-dark);
      font-weight: 600;
      border-bottom-right-radius: 5px;
    }

    .message.incident {
      background: linear-gradient(145deg, rgba(255, 159, 67, 0.3), rgba(255, 107, 107, 0.2));
      border: 2px solid var(--warning-orange);
      max-width: 95%;
    }

    .message.event-card {
      background: transparent;
      border: none;
      max-width: 100%;
      padding: 0;
    }

    .event-card-header {
      display: flex;
      align-items: center;
      gap: 8px;
      margin-bottom: 12px;
    }

    .event-card-badge {
      background: linear-gradient(135deg, var(--star-blue), var(--cosmic-purple));
      color: var(--white);
      padding: 4px 12px;
      border-radius: 12px;
      font-size: 0.75rem;
      font-weight: 700;
    }

    .event-card-title {
      font-weight: 900;
      font-size: 1.1rem;
      color: var(--moon-yellow);
    }

    .event-card-image {
      margin: 12px 0;
      border-radius: 12px;
      overflow: hidden;
      border: 3px solid var(--moon-yellow);
      box-shadow: 0 4px 15px rgba(255, 217, 61, 0.3);
    }

    .event-card-image img {
      width: 100%;
      height: auto;
      display: block;
      max-height: 400px;
      object-fit: contain;
      background: linear-gradient(145deg, rgba(255,255,255,0.1), rgba(255,255,255,0.05));
    }

    .event-card-section {
      margin: 12px 0;
      padding: 10px 12px;
      border-radius: 10px;
      background: rgba(255,255,255,0.05);
    }

    .event-card-section-title {
      font-weight: 700;
      font-size: 0.8rem;
      color: var(--star-blue);
      margin-bottom: 6px;
    }

    .event-card-section.situation {
      border-left: 3px solid var(--alien-green);
    }

    .event-card-section.event {
      border-left: 3px solid var(--warning-orange);
      background: rgba(255, 159, 67, 0.1);
    }

    .event-card-section.questions {
      border-left: 3px solid var(--cosmic-purple);
      background: rgba(168, 85, 247, 0.1);
    }

    .event-card-question {
      display: flex;
      gap: 8px;
      margin: 8px 0;
      font-size: 0.9rem;
      line-height: 1.5;
    }

    .event-card-question-num {
      background: var(--cosmic-purple);
      color: var(--white);
      width: 22px;
      height: 22px;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 0.75rem;
      font-weight: 700;
      flex-shrink: 0;
    }

    .message.lesson {
      background: linear-gradient(145deg, rgba(107, 203, 119, 0.3), rgba(78, 205, 196, 0.2));
      border: 2px solid var(--alien-green);
      max-width: 95%;
    }

    .message .sender {
      font-weight: 900;
      color: var(--moon-yellow);
      font-size: 0.75rem;
      margin-bottom: 4px;
    }

    .message.incident .sender { color: var(--warning-orange); }
    .message.lesson .sender { color: var(--alien-green); }

    .message-content { font-size: 0.92rem; }
    .message-content p { margin: 5px 0; }
    .message-content p:first-child { margin-top: 0; }
    .message-content p:last-child { margin-bottom: 0; }
    .message-content strong { color: var(--moon-yellow); }
    .message-content ul { margin: 8px 0; padding-left: 20px; }
    .message-content li { margin: 4px 0; }

    .incident-title {
      font-weight: 900;
      font-size: 1rem;
      color: var(--warning-orange);
      margin-bottom: 8px;
    }

    .item-highlight {
      display: inline-flex;
      align-items: center;
      gap: 4px;
      background: rgba(255, 217, 61, 0.2);
      border: 1px solid var(--moon-yellow);
      border-radius: 8px;
      padding: 4px 10px;
      margin: 3px 2px;
      font-size: 0.85rem;
    }

    .typing-indicator {
      display: flex;
      gap: 4px;
      padding: 5px 0;
    }

    .typing-dot {
      width: 7px; height: 7px;
      background: var(--moon-yellow);
      border-radius: 50%;
      animation: typingBounce 1.4s ease-in-out infinite;
    }

    .typing-dot:nth-child(2) { animation-delay: 0.2s; }
    .typing-dot:nth-child(3) { animation-delay: 0.4s; }

    @keyframes typingBounce {
      0%, 60%, 100% { transform: translateY(0); }
      30% { transform: translateY(-6px); }
    }

    .quick-replies {
      display: flex;
      flex-wrap: wrap;
      gap: 6px;
      padding: 10px 0;
      justify-content: center;
    }

    .quick-reply {
      font-family: 'Noto Sans TC', sans-serif;
      font-size: 0.85rem;
      font-weight: 600;
      padding: 9px 14px;
      border: 2px solid var(--star-blue);
      border-radius: 18px;
      background: rgba(78, 205, 196, 0.2);
      color: var(--white);
      cursor: pointer;
      transition: all 0.2s ease;
    }

    .quick-reply:hover {
      background: var(--star-blue);
      color: var(--space-dark);
    }

    .quick-reply.choice-btn {
      width: 100%;
      text-align: left;
      padding: 12px 16px;
      display: flex;
      align-items: center;
      gap: 10px;
      font-size: 0.9rem;
      background: linear-gradient(145deg, rgba(255,255,255,0.08), rgba(255,255,255,0.03));
      border-color: var(--cosmic-purple);
    }

    .quick-reply.choice-btn:hover {
      background: linear-gradient(135deg, var(--cosmic-purple), var(--star-blue));
      border-color: var(--moon-yellow);
    }

    .choice-letter {
      background: var(--cosmic-purple);
      color: var(--white);
      width: 24px;
      height: 24px;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      font-weight: 700;
      font-size: 0.8rem;
      flex-shrink: 0;
    }

    .choice-emoji {
      font-size: 1.3rem;
    }

    .quick-reply.primary {
      background: linear-gradient(135deg, var(--alien-green), var(--star-blue));
      border-color: var(--alien-green);
      color: var(--space-dark);
    }

    .quick-reply.warning {
      background: linear-gradient(135deg, var(--warning-orange), var(--rocket-red));
      border-color: var(--warning-orange);
      color: var(--space-dark);
    }

    .quick-reply.correct {
      background: linear-gradient(135deg, var(--alien-green), #22c55e);
      border-color: var(--alien-green);
      color: var(--space-dark);
    }

    .quick-reply.wrong {
      background: rgba(255, 107, 107, 0.3);
      border-color: var(--rocket-red);
      color: var(--white);
    }

    .quick-reply.item-choice {
      background: linear-gradient(145deg, rgba(255,255,255,0.12), rgba(255,255,255,0.05));
      border-color: var(--cosmic-purple);
      display: flex;
      align-items: center;
      gap: 6px;
      font-size: 0.9rem;
      padding: 10px 16px;
    }

    .quick-reply.item-choice:hover {
      background: var(--cosmic-purple);
      border-color: var(--moon-yellow);
    }

    .quick-reply.item-choice .item-emoji-btn {
      font-size: 1.2rem;
    }

    .choice-header {
      width: 100%;
      text-align: center;
      font-size: 0.85rem;
      color: var(--star-blue);
      margin-bottom: 6px;
      font-weight: 600;
    }

    .home-btn {
      position: fixed;
      top: 15px;
      left: 15px;
      z-index: 100;
      font-family: 'Noto Sans TC', sans-serif;
      font-size: 0.8rem;
      font-weight: 600;
      padding: 8px 14px;
      border: 2px solid var(--star-blue);
      border-radius: 20px;
      background: rgba(78, 205, 196, 0.2);
      color: var(--white);
      cursor: pointer;
      transition: all 0.2s ease;
      display: flex;
      align-items: center;
      gap: 5px;
    }

    .home-btn:hover {
      background: var(--star-blue);
      color: var(--space-dark);
    }

    footer {
      text-align: center;
      padding: 15px 0;
      font-size: 0.75rem;
      color: rgba(255,255,255,0.5);
      border-top: 1px solid rgba(255,255,255,0.1);
      margin-top: 15px;
    }

    footer strong {
      color: var(--star-blue);
    }

    .score-card {
      background: linear-gradient(145deg, rgba(107, 203, 119, 0.3), rgba(78, 205, 196, 0.2));
      border: 3px solid var(--alien-green);
      border-radius: 16px;
      padding: 16px;
      margin: 8px 0;
      text-align: center;
    }

    .score-number {
      font-weight: 900;
      font-size: 2.5rem;
      background: linear-gradient(90deg, var(--moon-yellow), var(--alien-green));
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-clip: text;
    }

    .score-label { color: var(--star-blue); font-weight: 600; font-size: 0.9rem; }

    .badge {
      display: inline-block;
      padding: 6px 16px;
      border-radius: 15px;
      font-weight: 900;
      font-size: 0.95rem;
      margin-top: 8px;
    }

    .badge.gold { background: linear-gradient(135deg, #ffd700, #ffb700); color: #333; }
    .badge.silver { background: linear-gradient(135deg, #c0c0c0, #a0a0a0); color: #333; }
    .badge.bronze { background: linear-gradient(135deg, #cd7f32, #b87333); color: white; }

    .results-table {
      width: 100%;
      margin: 10px 0;
      border-collapse: collapse;
      font-size: 0.8rem;
    }

    .results-table th {
      background: var(--cosmic-purple);
      padding: 6px 4px;
      text-align: center;
    }

    .results-table td {
      padding: 5px 4px;
      text-align: center;
      border-bottom: 1px solid rgba(255,255,255,0.1);
    }

    .results-table tr:nth-child(even) { background: rgba(255,255,255,0.05); }

    .diff-good { color: var(--alien-green); font-weight: 700; }
    .diff-ok { color: var(--moon-yellow); font-weight: 700; }
    .diff-bad { color: var(--rocket-red); font-weight: 700; }

    .progress-bar {
      background: rgba(255,255,255,0.1);
      border-radius: 10px;
      height: 8px;
      margin: 10px 0;
      overflow: hidden;
    }

    .progress-fill {
      height: 100%;
      background: linear-gradient(90deg, var(--alien-green), var(--star-blue));
      border-radius: 10px;
      transition: width 0.5s ease;
    }

    .feedback-correct {
      background: linear-gradient(145deg, rgba(107, 203, 119, 0.4), rgba(34, 197, 94, 0.3));
      border: 2px solid var(--alien-green);
    }

    .feedback-wrong {
      background: linear-gradient(145deg, rgba(255, 107, 107, 0.3), rgba(239, 68, 68, 0.2));
      border: 2px solid var(--rocket-red);
    }

    .dark body {
      background: linear-gradient(135deg, #000 0%, #1a1a2e 50%, #16213e 100%);
    }

    @media (max-width: 400px) {
      .item { padding: 8px; }
      .item-emoji { font-size: 1.2rem; width: 30px; }
      .item-name { font-size: 0.85rem; }
      .results-table { font-size: 0.75rem; }
      .quick-reply.item-choice { padding: 8px 12px; font-size: 0.85rem; }
    }
  </style>
</head>
<body>
  <div class="stars" id="stars"></div>

  <button class="home-btn" id="home-btn" onclick="goHome()" style="display:none">ğŸ  è¿”å›ä¸»é </button>

  <div class="container">
    <header>
      <h1 id="main-title">ğŸŒ™ Moon Survival Challenge</h1>
      <p class="subtitle" id="main-subtitle">Choose your language / é¸æ“‡èªè¨€</p>
    </header>

    <!-- Language Selection Screen -->
    <div id="lang-screen" class="screen active">
      <div class="story-box" style="text-align: center;">
        <h2>ğŸŒ Select Language / é¸æ“‡èªè¨€</h2>
        <p style="margin: 20px 0;">
          Choose your preferred language to begin the Moon Survival Challenge!<br><br>
          é¸æ“‡ä½ çš„èªè¨€é–‹å§‹æœˆçƒç”Ÿå­˜æŒ‘æˆ°ï¼
        </p>
        <div style="display: flex; flex-direction: column; gap: 15px; margin-top: 25px;">
          <button class="btn btn-primary" onclick="selectLanguage('en')" style="font-size: 1.1rem;">
            ğŸ‡¬ğŸ‡§ English
          </button>
          <button class="btn btn-secondary" onclick="selectLanguage('zh')" style="font-size: 1.1rem;">
            ğŸ‡­ğŸ‡° ä¸­æ–‡ï¼ˆç¹é«”ï¼‰
          </button>
        </div>
      </div>
    </div>

    <div id="intro-screen" class="screen">
      <div class="story-box">
        <h2 id="story-title">ğŸ‘¨â€ğŸš€ Your Space Adventure!</h2>
        <p id="story-content"></p>
      </div>

      <div class="instructions">
        <p id="intro-instructions"></p>
        <p id="intro-instructions-sub"></p>
      </div>

      <div class="center-btn">
        <button class="btn btn-primary" onclick="startRanking()" id="start-btn">ğŸš€ Start Challenge!</button>
      </div>
    </div>

    <div id="ranking-screen" class="screen">
      <div class="instructions">
        <p id="drag-instruction"></p>
      </div>
      <div class="items-list" id="items-list"></div>
      <div class="center-btn">
        <button class="btn btn-secondary" onclick="submitRankings()" id="submit-btn">âœ… Submit & Start Adventure!</button>
      </div>
    </div>

    <div id="chat-screen" class="screen">
      <div class="chat-container">
        <div class="messages" id="messages"></div>
        <div class="quick-replies" id="quick-replies"></div>
      </div>
    </div>

    <footer>
      <p>Created by <strong>Cheung Chung Wah Joyce</strong></p>
      <p>MEDD8869 Moon Survival Game (Primary Edition)</p>
    </footer>
  </div>

  <script>
    // Language system
    let currentLang = 'zh';

    const translations = {
      zh: {
        title: "ğŸŒ™ æœˆçƒç”Ÿå­˜å¤§æŒ‘æˆ°",
        subtitle: "çœ‹çœ‹ä½ æ˜¯å¦æ‡‚å¾—åœ¨æœˆçƒä¸Šç”Ÿå­˜ï¼",
        storyTitle: "ğŸ‘¨â€ğŸš€ ä½ çš„å¤ªç©ºå†’éšªï¼",
        storyContent: `å¤§äº‹ä¸å¥½ï¼ä½ çš„å¤ªç©ºèˆ¹åœ¨æœˆçƒå¢œæ¯€äº†ï¼ğŸš€ğŸ’¥<br><br>
          ä½ éœ€è¦æ­¥è¡Œ <strong>300 å…¬é‡Œ</strong>æ‰èƒ½åˆ°é”æœˆçƒåŸºåœ°ï¼<br><br>
          ä½ æ‰¾åˆ°äº† <strong>15 ä»¶ç‰©å“</strong>ï¼Œå¿…é ˆæ±ºå®šå“ªäº›æœ€é‡è¦ï¼<br><br>
          ä¹‹å¾Œæœƒæœ‰ <strong>4 å¼µäº‹ä»¶å¡</strong>ï¼Œå¹«åŠ©ä½ æ€è€ƒæœˆçƒç”Ÿå­˜çš„å•é¡Œï¼ğŸŒŸ`,
        instructions: "ğŸ‘† <strong>æ‹–æ‹‰ç‰©å“æ’åˆ—é †åºï¼</strong>",
        instructionsSub: "ğŸ† #1 = æœ€é‡è¦ â†’ #15 = æœ€ä¸é‡è¦",
        startBtn: "ğŸš€ é–‹å§‹æŒ‘æˆ°ï¼",
        dragInstruction: "ğŸ‘† æŒ‰ä½ä¸¦æ‹–æ‹‰ç‰©å“ä¾†æ’åˆ—é †åºï¼ #1 = æœ€é‡è¦",
        submitBtn: "âœ… äº¤å·é–‹å§‹å†’éšªï¼",
        homeBtn: "ğŸ  è¿”å›ä¸»é ",
        footer1: "Created by <strong>Cheung Chung Wah Joyce</strong>",
        footer2: "MEDD8869 Moon Survival Game (Primary Edition)",
        rankingReceived: "ğŸ‰ **å·²æ”¶åˆ°ä½ çš„æ’åï¼**\n\nç¾åœ¨é–‹å§‹æœˆçƒå†’éšªä¹‹æ—…... ä½ æœƒé‡åˆ° 4 å¼µäº‹ä»¶å¡ï¼\n\næ¯å¼µå¡éƒ½æœ‰æ€è€ƒå•é¡Œï¼Œå¹«åŠ©ä½ æ›´æ·±å…¥äº†è§£æœˆçƒç”Ÿå­˜çš„æŒ‘æˆ°ï¼ğŸš€",
        eventCardLabel: "ğŸŸ¦ äº‹ä»¶å¡",
        situationLabel: "ğŸ“ æƒ…å¢ƒèªªæ˜",
        eventLabel: "âš¡ çªç™¼äº‹ä»¶",
        questionsLabel: "ğŸ¤” æ€è€ƒå•é¡Œ",
        correctFeedback: "âœ… ç­”å°äº†ï¼å¤ªæ£’äº†ï¼",
        wrongFeedback: "âŒ ä¸å¤ªå°å–”ï¼",
        nextCardBtn: "â¡ï¸ ä¸‹ä¸€å¼µäº‹ä»¶å¡ï¼",
        viewResultsBtn: "ğŸ† æŸ¥çœ‹æœ€çµ‚çµæœï¼",
        congratsMsg: "ğŸŠ **æ­å–œä½ å®Œæˆäº†æ‰€æœ‰äº‹ä»¶å¡ï¼**\n\nç¾åœ¨ä¾†çœ‹çœ‹ä½ çš„æ’åæˆç¸¾...",
        scoreLabel: "ä½ çš„åˆ†æ•¸",
        scoreTip: "ï¼ˆåˆ†æ•¸è¶Šä½è¶Šå¥½ï¼0åˆ† = å®Œç¾ï¼ï¼‰",
        badgeExpert: "ğŸ† å¤ªç©ºå°ˆå®¶ï¼",
        badgeGood: "ğŸŒŸ å„ªç§€å¤ªç©ºäººï¼",
        badgeNovice: "ğŸš€ å¤ªç©ºæ–°æ‰‹ï¼",
        tableItem: "ç‰©å“",
        tableYou: "ä½ ",
        tableNasa: "NASA",
        tableDiff: "å·®",
        nasaQuestion: "**ğŸ“š æƒ³çŸ¥é“ NASA å°ˆå®¶çš„æ¨™æº–æ’åå—ï¼Ÿ**",
        viewNasaBtn: "ğŸš€ æŸ¥çœ‹ NASA æ¨™æº–ç­”æ¡ˆï¼",
        restartBtn: "ğŸ”„ å†ç©ä¸€æ¬¡ï¼",
        nasaTitle: "ğŸŒŸ **NASA å°ˆå®¶æ¨™æº–æ’å**\n\nä»¥ä¸‹æ˜¯ NASA å¤ªç©ºå°ˆå®¶æ ¹æ“šæœˆçƒç”Ÿå­˜éœ€æ±‚è€Œåˆ¶å®šçš„å®˜æ–¹æ’åï¼š",
        nasaOfficialTitle: "ğŸ›ï¸ NASA å®˜æ–¹æ¨™æº–ç­”æ¡ˆ",
        tableRank: "æ’å",
        tableReason: "åŸå› ",
        learningSummary: `**ğŸ“ å­¸ç¿’é‡é»ç¸½çµï¼š**

**ğŸ¥‡ æœ€é‡è¦ï¼ˆç¬¬1-5åï¼‰ï¼š**
- **æ°§æ°£ç“¶** - æ²’æœ‰ç©ºæ°£ï¼Œå¹¾åˆ†é˜å°±æœƒæ­»äº¡ï¼
- **é£²ç”¨æ°´** - äººé«”éœ€è¦æ°´ä¾†ç¶­æŒç”Ÿå‘½
- **æ˜Ÿåœ–** - æœˆçƒæ²’æœ‰GPSï¼Œé æ˜Ÿæ˜Ÿè¾¨èªæ–¹å‘
- **å¤ªç©ºé£Ÿç‰©åŒ…** - æ­¥è¡Œ300å…¬é‡Œéœ€è¦èƒ½é‡
- **å¤ªé™½èƒ½æ”¶éŸ³æ©Ÿ** - å¯ä»¥èˆ‡åŸºåœ°è¯çµ¡æ±‚æ•‘

**ğŸ¥ˆ æœ‰ç”¨ï¼ˆç¬¬6-10åï¼‰ï¼š**
- æ”€çˆ¬ç¹©ã€æ€¥æ•‘ç®±ã€åå…‰çµ²ç¶¢å¸ƒã€å……æ°£å¸³ç¯·ã€ä¿¡è™Ÿé¡

**ğŸ¥‰ ä¸å¤ªæœ‰ç”¨ï¼ˆç¬¬11-15åï¼‰ï¼š**
- **äºŒæ°§åŒ–ç¢³æ»…ç«å™¨** - åªèƒ½ç•¶æ¨é€²å™¨ç”¨
- **è„«æ°´å¥¶ç²‰** - æ²’æ°´å°±æ²’ç”¨
- **é›»æ± ç™¼ç†±åŒ…** - å¤ªç©ºè¡£å·²ä¿æš–
- **é«˜å€ç‡é›™ç­’æœ›é é¡** - åªèƒ½çœ‹é è™•ï¼Œä¸èƒ½å°èˆª
- **æ”¾å¤§é¡** - æœˆçƒæ²’æ°§æ°£ï¼Œç„¡æ³•ç”Ÿç«ï¼`,
        learnMore: "äº†è§£æ›´å¤šï¼š",
        senderBot: "ğŸ¤– å¤ªç©ºåšå£«",
        senderIncident: "âš ï¸ çªç™¼äº‹ä»¶",
        senderLesson: "ğŸ“š å­¸ç¿’é‡é»"
      },
      en: {
        title: "ğŸŒ™ Moon Survival Challenge",
        subtitle: "Can you survive on the Moon?",
        storyTitle: "ğŸ‘¨â€ğŸš€ Your Space Adventure!",
        storyContent: `Oh no! Your spaceship has crashed on the Moon! ğŸš€ğŸ’¥<br><br>
          You need to walk <strong>300 km</strong> to reach the lunar base!<br><br>
          You found <strong>15 items</strong> and must decide which are most important!<br><br>
          Then there will be <strong>4 event cards</strong> to help you think about Moon survival! ğŸŒŸ`,
        instructions: "ğŸ‘† <strong>Drag items to rank them!</strong>",
        instructionsSub: "ğŸ† #1 = Most Important â†’ #15 = Least Important",
        startBtn: "ğŸš€ Start Challenge!",
        dragInstruction: "ğŸ‘† Hold and drag items to rank them! #1 = Most Important",
        submitBtn: "âœ… Submit & Start Adventure!",
        homeBtn: "ğŸ  Home",
        footer1: "Created by <strong>Cheung Chung Wah Joyce</strong>",
        footer2: "MEDD8869 Moon Survival Game (Primary Edition)",
        rankingReceived: "ğŸ‰ **Your ranking is received!**\n\nNow begins your lunar adventure... You will encounter 4 event cards!\n\nEach card has thinking questions to help you understand Moon survival challenges! ğŸš€",
        eventCardLabel: "ğŸŸ¦ Event Card",
        situationLabel: "ğŸ“ Situation",
        eventLabel: "âš¡ Emergency",
        questionsLabel: "ğŸ¤” Think About It",
        correctFeedback: "âœ… Correct! Great job!",
        wrongFeedback: "âŒ Not quite right!",
        nextCardBtn: "â¡ï¸ Next Event Card!",
        viewResultsBtn: "ğŸ† View Final Results!",
        congratsMsg: "ğŸŠ **Congratulations on completing all event cards!**\n\nLet's see your ranking score...",
        scoreLabel: "Your Score",
        scoreTip: "(Lower is better! 0 = Perfect!)",
        badgeExpert: "ğŸ† Space Expert!",
        badgeGood: "ğŸŒŸ Great Astronaut!",
        badgeNovice: "ğŸš€ Space Rookie!",
        tableItem: "Item",
        tableYou: "You",
        tableNasa: "NASA",
        tableDiff: "Diff",
        nasaQuestion: "**ğŸ“š Want to see NASA's official ranking?**",
        viewNasaBtn: "ğŸš€ View NASA's Answer!",
        restartBtn: "ğŸ”„ Play Again!",
        nasaTitle: "ğŸŒŸ **NASA Expert Ranking**\n\nHere is NASA's official ranking based on Moon survival needs:",
        nasaOfficialTitle: "ğŸ›ï¸ NASA Official Answer",
        tableRank: "Rank",
        tableReason: "Reason",
        learningSummary: `**ğŸ“ Key Learning Points:**

**ğŸ¥‡ Most Important (1-5):**
- **Oxygen Tanks** - No air means death in minutes!
- **Drinking Water** - Essential for survival
- **Star Chart** - No GPS on Moon, use stars for navigation
- **Astronaut Food Packs** - Walking 300km needs energy
- **Solar-Powered Radio** - Contact base for rescue

**ğŸ¥ˆ Useful (6-10):**
- Climbing Rope, First Aid Kit, Shiny Silk Sheet, Inflatable Shelter, Signal Mirror

**ğŸ¥‰ Less Useful (11-15):**
- **CO2 Fire Extinguisher** - Only useful as propellant
- **Dehydrated Milk** - Needs water to use
- **Portable Heating Unit** - Spacesuit already has heating
- **High-Power Binoculars** - Can see far but can't navigate
- **Magnifying Glass** - No oxygen, can't start fire!`,
        learnMore: "Learn more:",
        senderBot: "ğŸ¤– Dr. Space",
        senderIncident: "âš ï¸ Emergency",
        senderLesson: "ğŸ“š Learning Point"
      }
    };

    // Items in both languages
    const itemsData = {
      zh: [
        { id: 1, emoji: "ğŸ›¢ï¸", name: "æ°§æ°£ç“¶", nasaRank: 1, reason: "æœˆçƒæ²’æœ‰ç©ºæ°£ï¼Œé€™æ˜¯ç”Ÿå­˜å¿…éœ€å“ï¼æ²’æœ‰æ°§æ°£å¹¾åˆ†é˜å°±æœƒæ­»äº¡ï¼æ¯å€‹é‡ 45 å…¬æ–¤ã€‚" },
        { id: 2, emoji: "ğŸ’§", name: "é£²ç”¨æ°´", nasaRank: 2, reason: "äººé«”éœ€è¦æ°´ä¾†ç¶­æŒç”Ÿå‘½ï¼Œæœˆçƒæ²’æœ‰æ°´æºï¼Œ20 å…¬å‡è¶³å¤ å¹¾å¤©ä½¿ç”¨ï¼" },
        { id: 3, emoji: "ğŸ—ºï¸", name: "æ˜Ÿåœ–", nasaRank: 3, reason: "æœˆçƒæ²’æœ‰ GPSï¼Œéœ€è¦é æ˜Ÿæ˜Ÿä¾†è¾¨èªæ–¹å‘ï¼æ˜Ÿåœ–å¯ä»¥å¹«åŠ©ä½ æ‰¾åˆ°æ­£ç¢ºè·¯ç·šï¼" },
        { id: 4, emoji: "ğŸ«", name: "å¤ªç©ºé£Ÿç‰©åŒ…", nasaRank: 4, reason: "æ­¥è¡Œ 300 å…¬é‡Œéœ€è¦å¤§é‡èƒ½é‡ï¼Œ12 å…¬æ–¤çš„æ¿ƒç¸®é£Ÿç‰©ç‡Ÿé¤Šè±å¯Œï¼" },
        { id: 5, emoji: "ğŸ“»", name: "å¤ªé™½èƒ½æ”¶éŸ³æ©Ÿ", nasaRank: 5, reason: "å¯ä»¥èˆ‡æœˆçƒåŸºåœ°è¯çµ¡ï¼Œè«‹æ±‚æ•‘æ´ï¼å¤ªé™½èƒ½ä¾›é›»ï¼Œä¸ç”¨æ“”å¿ƒé›»æ± ï¼" },
        { id: 6, emoji: "ğŸª¢", name: "æ”€çˆ¬ç¹©", nasaRank: 6, reason: "15 ç±³é•·çš„ç¹©å­å¯ä»¥ç¶ä½éšŠå‹ä¸€èµ·è¡Œèµ°ï¼Œé€šéå±éšªåœ°å¸¶æ™‚äº’ç›¸å¹«åŠ©ï¼" },
        { id: 7, emoji: "ğŸ©¹", name: "æ€¥æ•‘ç®±", nasaRank: 7, reason: "å—å‚·æ™‚å¯ä»¥åŒ…ç´®å‚·å£ï¼Œé‚„æœ‰ä¿®è£œå¤ªç©ºè¡£çš„ææ–™ï¼" },
        { id: 8, emoji: "âœ¨", name: "åå…‰çµ²ç¶¢å¸ƒ", nasaRank: 8, reason: "å¯ä»¥åå°„å¤ªé™½å…‰ã€é®æ“‹è¼»å°„ã€æ¬é‹ç‰©å“ï¼Œç”¨é€”å»£æ³›ï¼" },
        { id: 9, emoji: "â›º", name: "å……æ°£å¸³ç¯·", nasaRank: 9, reason: "å¯ä»¥æä¾›è‡¨æ™‚åº‡è­·æ‰€ï¼Œé®æ“‹å¤ªé™½è¼»å°„å’Œå®‡å®™å°„ç·šï¼" },
        { id: 10, emoji: "ğŸª", name: "ä¿¡è™Ÿé¡", nasaRank: 10, reason: "å¯ä»¥åå°„å¤ªé™½å…‰ç™¼å‡ºæ±‚æ•‘ä¿¡è™Ÿï¼Œè®“æ•‘æ´éšŠçœ‹åˆ°ä½ çš„ä½ç½®ï¼" },
        { id: 11, emoji: "ğŸ§¯", name: "äºŒæ°§åŒ–ç¢³æ»…ç«å™¨", nasaRank: 11, reason: "å¯ä»¥ç•¶ä½œå™´å°„æ¨é€²å™¨ä½¿ç”¨ï¼å™´å‡ºçš„æ°£é«”å¯ä»¥æ¨å‹•ä½ å‰é€²ï¼" },
        { id: 12, emoji: "ğŸ¥›", name: "è„«æ°´å¥¶ç²‰", nasaRank: 12, reason: "æœ‰ç‡Ÿé¤Šä½†éœ€è¦åŠ æ°´ï¼Œæ²’æœ‰æ°´å°±æ²’ä»€éº¼ç”¨è™•ï¼" },
        { id: 13, emoji: "ğŸ”‹", name: "é›»æ± ç™¼ç†±åŒ…", nasaRank: 13, reason: "å¤ªç©ºè¡£å·²ç¶“æœ‰ä¿æš–åŠŸèƒ½ï¼Œåœ¨é™½å…‰ç…§å°„å€åŸŸä¸å¤ªéœ€è¦ï¼" },
        { id: 14, emoji: "ğŸ”­", name: "é«˜å€ç‡é›™ç­’æœ›é é¡", nasaRank: 14, reason: "å¯ä»¥çœ‹åˆ°é è™•åœ°æ¨™ï¼Œä½†å°å°èˆªå¹«åŠ©ä¸å¤§ï¼Œæ¯”æ˜Ÿåœ–å·®ï¼" },
        { id: 15, emoji: "ğŸ”", name: "æ”¾å¤§é¡", nasaRank: 15, reason: "æœˆçƒæ²’æœ‰æ°§æ°£ï¼Œç„¡æ³•ç”¨æ”¾å¤§é¡èšå…‰ç”Ÿç«ï¼åŸºæœ¬ä¸Šæ²’æœ‰ç”¨é€”ï¼" }
      ],
      en: [
        { id: 1, emoji: "ğŸ›¢ï¸", name: "Oxygen Tanks (45 kg ea.)", nasaRank: 1, reason: "No air on Moon - essential for survival! You'll die in minutes without oxygen!" },
        { id: 2, emoji: "ğŸ’§", name: "Drinking Water (20 Liters)", nasaRank: 2, reason: "Humans need water to survive. No water sources on Moon, 20 liters lasts several days!" },
        { id: 3, emoji: "ğŸ—ºï¸", name: "Star Chart", nasaRank: 3, reason: "No GPS on Moon! You need stars to find direction. Star chart helps you find the right path!" },
        { id: 4, emoji: "ğŸ«", name: "12kg Astronaut Food Packs", nasaRank: 4, reason: "Walking 300km needs lots of energy. 12kg of concentrated food is nutritious!" },
        { id: 5, emoji: "ğŸ“»", name: "Solar-Powered Radio", nasaRank: 5, reason: "Can contact lunar base for rescue! Solar-powered, no battery worries!" },
        { id: 6, emoji: "ğŸª¢", name: "15m Climbing Rope", nasaRank: 6, reason: "15m rope can tie teammates together, helping each other through dangerous areas!" },
        { id: 7, emoji: "ğŸ©¹", name: "First Aid Kit", nasaRank: 7, reason: "Can bandage wounds and has materials to repair spacesuits!" },
        { id: 8, emoji: "âœ¨", name: "Shiny Silk Sheet", nasaRank: 8, reason: "Reflects sunlight, blocks radiation, carries items - many uses!" },
        { id: 9, emoji: "â›º", name: "Inflatable Shelter", nasaRank: 9, reason: "Provides temporary shelter, blocks solar radiation and cosmic rays!" },
        { id: 10, emoji: "ğŸª", name: "Signal Mirror", nasaRank: 10, reason: "Reflects sunlight as distress signal, helps rescue team find you!" },
        { id: 11, emoji: "ğŸ§¯", name: "CO2 Fire Extinguisher", nasaRank: 11, reason: "Can be used as jet propulsion! The gas can push you forward!" },
        { id: 12, emoji: "ğŸ¥›", name: "Dehydrated Milk", nasaRank: 12, reason: "Nutritious but needs water to use. Useless without water!" },
        { id: 13, emoji: "ğŸ”‹", name: "Portable Heating Unit", nasaRank: 13, reason: "Spacesuit already has heating. Not needed in sunlit areas!" },
        { id: 14, emoji: "ğŸ”­", name: "High-Power Binoculars", nasaRank: 14, reason: "Can see distant landmarks, but not helpful for navigation. Star chart is better!" },
        { id: 15, emoji: "ğŸ”", name: "Magnifying Glass", nasaRank: 15, reason: "No oxygen on Moon - can't start fire with magnifying glass! Basically useless!" }
      ]
    };

    // Event cards in both languages
    const eventCardsData = {
      zh: [
        {
          id: 1,
          title: "ğŸƒâ€â™‚ï¸ éš±å½¢çš„ç‰†",
          image: "https://pfst.cf2.poecdn.net/base/image/6080844d122a1145b6e5d111d894e0fbdbc71a58aad396afae02f03a61cf2815?w=1024&h=1536",
          situation: "ä½ æ­£æ»‘å‘æ‡¸å´–é‚Šç·£ï¼ä½ è¦å¦‚ä½•æŠŠè‡ªå·±æ¨å›ä¾†ï¼Ÿ",
          event: "åœ¨æœˆçƒä¸Šï¼Œä½ çš„ã€Œè³ªé‡ã€å’Œåœ¨åœ°çƒä¸Šä¸€æ¨£ï¼Œä½†æ²’æœ‰ç©ºæ°£å¹«ä½ æ¸›é€Ÿã€‚é›–ç„¶ä½ æ„Ÿè¦ºå¾ˆè¼•ï¼Œä½†ä½ çš„èº«é«”å°±åƒä¸€è¼›å¾ˆé‡çš„å¡è»Šï¼Œä¸€æ—¦é–‹å§‹ç§»å‹•å°±å¾ˆé›£åœä¸‹ä¾†ã€‚",
          questions: [
            "å¦‚æœæ²’æœ‰é¢¨é˜»æ“‹ä½ ï¼Œç‚ºä»€éº¼ä½ çš„èº«é«”æœƒä¸€ç›´å‘å‰è¡ï¼Ÿ"
          ],
          itemQuestion: "ä½ èªç‚ºæ‡‰ä½¿ç”¨å“ªä¸€é …å·¥å…·ä¾†ç”¢ç”Ÿã€Œæ¨åŠ›ã€ï¼Œæ•‘ä½ é›¢é–‹é‚Šç·£ï¼Ÿ",
          correctItem: "äºŒæ°§åŒ–ç¢³æ»…ç«å™¨",
          wrongItems: ["æ”€çˆ¬ç¹©", "é›»æ± ç™¼ç†±åŒ…"],
          howToSolve: "å°‡æ»…ç«å™¨çš„å™´å˜´æŒ‡å‘æ‡¸å´–çš„æ–¹å‘ï¼ˆä½ çš„å‰æ–¹ï¼‰ï¼Œç„¶å¾Œæ‹‰å‹•æ‰‹æŸ„å™´å‡ºæ°£é«”ã€‚",
          explanation: `ğŸ§¯ **æ­£ç¢ºç­”æ¡ˆï¼šäºŒæ°§åŒ–ç¢³æ»…ç«å™¨ï¼**

**è§£æ±ºæ–¹æ³•ï¼š** å°‡æ»…ç«å™¨çš„å™´å˜´æŒ‡å‘æ‡¸å´–çš„æ–¹å‘ï¼ˆä½ çš„å‰æ–¹ï¼‰ï¼Œç„¶å¾Œæ‹‰å‹•æ‰‹æŸ„å™´å‡ºæ°£é«”ã€‚

**ç§‘å­¸åŸç†ï¼š** é€™é‹ç”¨äº†**ç‰›é “ç¬¬ä¸‰å®šå¾‹**ã€‚ç•¶æ°£é«”å‘å‰å™´å°„æ™‚ï¼Œå®ƒæœƒä»¥ç›¸ç­‰çš„åŠ›é‡ã€Œè¸¢ã€ä½ çš„èº«é«”å‘å¾Œï¼Œå¹«åŠ©ä½ åœ¨çœŸç©ºä¸­åœä¸‹ä¾†æˆ–æ”¹è®Šæ–¹å‘â€”â€”å› ç‚ºé‚£è£¡æ²’æœ‰ç©ºæ°£å¯ä»¥è®“ä½ æ¨å‹•ã€‚

<div class="event-card-question"><span class="event-card-question-num">1</span><span>**åä½œç”¨åŠ›**ï¼šç•¶ä½ å‘å‰æ–¹å™´å‡ºæ°£é«”ï¼Œæ°£é«”æœƒç”¢ç”Ÿä¸€è‚¡åŠ›é‡æŠŠä½ å‘å¾Œæ¨ã€‚</span></div>
<div class="event-card-question"><span class="event-card-question-num">2</span><span>**å…‹æœæ…£æ€§**ï¼šé€™è‚¡å¼·å¤§çš„æ¨åŠ›èƒ½æŠµéŠ·ä½ è¡å‘æ‡¸å´–çš„åŠ›é‡ï¼Œå¹«ä½ åœä¸‹ä¾†ã€‚</span></div>
<div class="event-card-question"><span class="event-card-question-num">3</span><span>**å¤ªç©ºç§‘å­¸**ï¼šåœ¨æ²’æœ‰ç©ºæ°£çš„åœ°æ–¹ï¼Œé€™æ˜¯å”¯ä¸€èƒ½è®“ä½ æ”¹è®Šç§»å‹•æ–¹å‘çš„æ–¹æ³•ï¼</span></div>`
        },
        {
          id: 2,
          title: "ğŸ•³ï¸ éš±è—çš„å¤©çª—",
          image: "https://pfst.cf2.poecdn.net/base/image/c745dcb2496017d775da77744db8d39d8af0c4c0ac664d4f7ab2a04fcd7719d7?w=1024&h=1536",
          situation: "ä¸€å€‹å·¨å¤§çš„æ´å£é€šå¾€åœ°ä¸‹ã€‚ä½ è¦å¦‚ä½•å®‰å…¨é€²å…¥ï¼Ÿ",
          event: "ä½ ç™¼ç¾äº†ä¸€å€‹é€šå¾€åœ°ä¸‹ç†”å²©éš§é“çš„å·¨å¤§ã€Œå¤©çª—ã€ã€‚é€™æ˜¯èº²é¿é«˜æº«å’Œè¼»å°„çš„å®Œç¾åº‡è­·æ‰€ï¼Œä½†ä¸‹é™çš„å¡åº¦å¾ˆé™¡å³­ä¸”å±éšªã€‚ä½ å¿…é ˆè®“åœ˜éšŠå®‰å…¨ä¸‹å»ï¼Œä¸è®“ä»»ä½•äººå—å‚·ã€‚",
          questions: [
            "ç‚ºä»€éº¼é™è½å‚˜åœ¨æœˆçƒä¸Šä¸èƒ½åƒåœ¨åœ°çƒä¸Šé‚£æ¨£è®“ä½ ç·©ç·©é£„è½ï¼Ÿ"
          ],
          itemQuestion: "ä½ èªç‚ºæ‡‰ä½¿ç”¨å“ªä¸€é …å·¥å…·ä¾†å¹«åŠ©åœ˜éšŠå®‰å…¨é€²å…¥ï¼Ÿ",
          correctItem: "åå…‰çµ²ç¶¢å¸ƒ",
          wrongItems: ["å……æ°£å¸³ç¯·", "æ€¥æ•‘ç®±"],
          howToSolve: "ä¸è¦å˜—è©¦ç”¨å®ƒä¾†é£›ï¼ç›¸åï¼ŒæŠŠé€™ç¨®å …éŸŒçš„å¸ƒæ–™ç•¶ä½œä¿è­·æ€§æ»‘é“ä½¿ç”¨ã€‚æŠŠå®ƒé‹ªåœ¨å°–éŠ³çš„å²©çŸ³ä¸Šæ»‘ä¸‹å»ï¼Œæˆ–è€…ç”¨å®ƒåŒ…è£¹ç‰©è³‡ï¼Œé€™æ¨£åœ¨å¾€ä¸‹æ”¾æ™‚ä¸æœƒæå£ã€‚",
          explanation: `âœ¨ **æ­£ç¢ºç­”æ¡ˆï¼šåå…‰çµ²ç¶¢å¸ƒï¼**

**è§£æ±ºæ–¹æ³•ï¼š** ä¸è¦å˜—è©¦ç”¨å®ƒä¾†é£›ï¼ç›¸åï¼ŒæŠŠé€™ç¨®å …éŸŒçš„å¸ƒæ–™ç•¶ä½œä¿è­·æ€§æ»‘é“ä½¿ç”¨ã€‚æŠŠå®ƒé‹ªåœ¨å°–éŠ³çš„å²©çŸ³ä¸Šæ»‘ä¸‹å»ï¼Œæˆ–è€…ç”¨å®ƒåŒ…è£¹ç‰©è³‡ï¼Œé€™æ¨£åœ¨å¾€ä¸‹æ”¾æ™‚ä¸æœƒæå£ã€‚

**ç§‘å­¸åŸç†ï¼š** é™è½å‚˜åœ¨æœˆçƒä¸Šç„¡æ³•è®“ä½ ã€Œé£„æµ®ã€ï¼Œå› ï¿½ï¿½ï¿½æ²’æœ‰ç©ºæ°£å¯ä»¥æ’é–‹å¸ƒæ–™ã€‚ä½†æ˜¯ï¼Œå°¼é¾éå¸¸å …éŸŒä¸”è¼•ä¾¿ï¼Œæ˜¯ä¿è­·ä½ çš„å¤ªç©ºè¡£ä¸è¢«å°–éŠ³å¦‚ç»ç’ƒçš„æœˆçƒå²©çŸ³åˆºç ´çš„å®Œç¾å·¥å…·ã€‚

<div class="event-card-question"><span class="event-card-question-num">1</span><span>**ç„¡ç©ºæ°£é˜»åŠ›**ï¼šæœˆçƒæ²’æœ‰å¤§æ°£å±¤ï¼Œé™è½å‚˜ç„¡æ³•åƒåœ¨åœ°çƒä¸€æ¨£å¼µé–‹æ¸›é€Ÿã€‚</span></div>
<div class="event-card-question"><span class="event-card-question-num">2</span><span>**ææ–™ç‰¹æ€§**ï¼šçµ²ç¶¢å¸ƒå …éŸŒè€ç”¨ï¼Œå¯ä»¥ä¿è­·ä½ å…å—å°–éŠ³å²©çŸ³å‚·å®³ã€‚</span></div>
<div class="event-card-question"><span class="event-card-question-num">3</span><span>**å‰µæ„é‹ç”¨**ï¼šåŒä¸€ä»¶å·¥å…·åœ¨ä¸åŒç’°å¢ƒä¸‹æœ‰ä¸åŒçš„ç”¨é€”ï¼</span></div>`
        },
        {
          id: 3,
          title: "ğŸ§­ ç£éµä¹‹è¬",
          image: "https://pfst.cf2.poecdn.net/base/image/41b2e1dd71c53dd9b73581f727098584f31206d94a6247b91f1cb3b07c1898e7?w=1024&h=1536",
          situation: "ä½ çš„æŒ‡å—é‡å£äº†ï¼ç”¨æ˜Ÿæ˜Ÿæ‰¾åˆ°å›å®¶çš„è·¯ã€‚",
          event: "ä½ è¿·å¤±åœ¨ä¸€ç‰‡å¹³å¦çš„å¹³åŸä¸Šï¼Œé›»å­GPSä¹Ÿå£äº†ã€‚åœ¨åœ°çƒä¸Šï¼Œä½ æœƒä½¿ç”¨ç£æ€§æŒ‡å—é‡ï¼Œä½†åœ¨æœˆçƒä¸Šæ²’æœ‰ç£ã€ŒåŒ—æ¥µã€ä¾†ç§»å‹•æŒ‡é‡ã€‚ä½ å¿…é ˆåˆ©ç”¨å¤©ç©ºæ‰¾åˆ°è¿”å›åŸºåœ°çš„è·¯ã€‚",
          questions: [
            "ç‚ºä»€éº¼ä½ å¯ä»¥åœ¨æœˆçƒçš„ç™½å¤©çœ‹åˆ°æ˜Ÿæ˜Ÿï¼Œä½†åœ¨åœ°çƒä¸Šå»çœ‹ä¸åˆ°ï¼Ÿ"
          ],
          itemQuestion: "ä½ èªç‚ºæ‡‰ä½¿ç”¨å“ªä¸€é …å·¥å…·ä¾†è¾¨åˆ¥æ–¹å‘ï¼Ÿ",
          correctItem: "æ˜Ÿåœ–",
          wrongItems: ["ä¿¡è™Ÿé¡", "é«˜å€ç‡é›™ç­’æœ›é é¡"],
          howToSolve: "æŠŠæ˜Ÿåœ–èˆ‰å‘å¤©ç©ºã€‚å› ç‚ºæœˆçƒæ²’æœ‰å¤§æ°£å±¤ç”¢ç”Ÿè—å¤©ï¼Œå³ä½¿åœ¨ç™½å¤©ä¹Ÿèƒ½çœ‹åˆ°æ˜Ÿæ˜Ÿã€‚åˆ©ç”¨æ˜Ÿåº§ï¼ˆæ˜Ÿæ˜Ÿçš„åœ–æ¡ˆï¼‰ä¾†åˆ¤æ–·å“ªå€‹æ–¹å‘å¯ä»¥å›åˆ°ä½ çš„å¤ªç©ºèˆ¹ã€‚",
          explanation: `ğŸ—ºï¸ **æ­£ç¢ºç­”æ¡ˆï¼šæ˜Ÿåœ–ï¼**

**è§£æ±ºæ–¹æ³•ï¼š** æŠŠæ˜Ÿåœ–èˆ‰å‘å¤©ç©ºã€‚å› ç‚ºæœˆçƒæ²’æœ‰å¤§æ°£å±¤ç”¢ç”Ÿè—å¤©ï¼Œå³ä½¿åœ¨ç™½å¤©ä¹Ÿèƒ½çœ‹åˆ°æ˜Ÿæ˜Ÿã€‚åˆ©ç”¨æ˜Ÿåº§ï¼ˆæ˜Ÿæ˜Ÿçš„åœ–æ¡ˆï¼‰ä¾†åˆ¤æ–·å“ªå€‹æ–¹å‘å¯ä»¥å›åˆ°ä½ çš„å¤ªç©ºèˆ¹ã€‚

**ç§‘å­¸åŸç†ï¼š** æœˆçƒæ²’æœ‰å…¨çƒæ€§çš„ç£å ´ï¼Œæ‰€ä»¥æ™®é€šæŒ‡å—é‡æ¯«ç„¡ç”¨è™•ã€‚ç”±æ–¼æ˜Ÿæ˜Ÿçš„ä½ç½®æ°¸é ä¸è®Šï¼Œè€Œä¸”æ²’æœ‰é›²å±¤é®æ“‹ï¼Œå®ƒå€‘æ˜¯å¤ªç©ºä¸­æœ€å¯é çš„ã€Œè·¯æ¨™ã€ã€‚

<div class="event-card-question"><span class="event-card-question-num">1</span><span>**ç„¡ç£å ´**ï¼šæœˆçƒæ²’æœ‰åƒåœ°çƒé‚£æ¨£çš„ç£å ´ï¼ŒæŒ‡å—é‡ç„¡æ³•ä½¿ç”¨ã€‚</span></div>
<div class="event-card-question"><span class="event-card-question-num">2</span><span>**ç„¡å¤§æ°£å±¤**ï¼šæ²’æœ‰ç©ºæ°£æ•£å°„é™½å…‰ï¼Œæ‰€ä»¥ç™½å¤©ä¹Ÿèƒ½çœ‹åˆ°æ˜Ÿæ˜Ÿã€‚</span></div>
<div class="event-card-question"><span class="event-card-question-num">3</span><span>**æ†æ˜Ÿå°èˆª**ï¼šæ˜Ÿæ˜Ÿçš„ä½ç½®å›ºå®šä¸è®Šï¼Œæ˜¯å¤ªç©ºä¸­æœ€å¯é çš„å°èˆªå·¥å…·ï¼</span></div>`
        },
        {
          id: 4,
          title: "ğŸŒ€ æœˆçƒã€Œåœ°éœ‡ã€",
          image: "https://pfst.cf2.poecdn.net/base/image/28a0f297f5562b3c46cc326ba59ff3664a7d76a9d6a5a21c2e674cdb7e730805?w=1024&h=1536",
          situation: "åœ°é¢æ­£åœ¨éœ‡å‹•ï¼ä½ å€‘è¦å¦‚ä½•ä¿æŒåœ˜çµï¼Ÿ",
          event: "ä½ è…³ä¸‹çš„åœ°é¢æ­£åœ¨éœ‡å‹•ï¼æœˆçƒåœ¨å†·å»æ™‚æœƒæ”¶ç¸®ï¼Œå°è‡´æŒçºŒå¾ˆé•·æ™‚é–“çš„ã€Œæœˆéœ‡ã€ã€‚åœ¨ä½é‡åŠ›ç’°å¢ƒä¸‹ï¼Œå³ä½¿æ˜¯å°å°çš„éœ‡å‹•ä¹Ÿå¯èƒ½è®“ä½ å¤±å»å¹³è¡¡ï¼Œé£„é›¢ä½ çš„éšŠå‹ã€‚",
          questions: [
            "å¦‚æœåœ°é¢åœ¨ç§»å‹•ï¼Œç‚ºä»€éº¼ç¶åœ¨æœ‹å‹èº«ä¸Šæ¯”ç¨è‡ªç«™ç«‹æ›´å®‰å…¨ï¼Ÿ"
          ],
          itemQuestion: "ä½ èªç‚ºæ‡‰ä½¿ç”¨å“ªä¸€é …å·¥å…·ä¾†ä¿è­·åœ˜éšŠå®‰å…¨ï¼Ÿ",
          correctItem: "æ”€çˆ¬ç¹©",
          wrongItems: ["å……æ°£å¸³ç¯·", "é£²ç”¨æ°´"],
          howToSolve: "å¿«é€Ÿç”¨ç¹©å­æŠŠæ‰€æœ‰äº”åéšŠå“¡ç¶åœ¨ä¸€èµ·ã€‚å¦‚æœå¯èƒ½çš„è©±ï¼Œç”¨å‰©é¤˜çš„ç¹©å­æŠŠè‡ªå·±å›ºå®šåœ¨ä¸€å¡Šå¤§è€Œç©©å®šçš„å²©çŸ³ä¸Šã€‚",
          explanation: `ğŸª¢ **æ­£ç¢ºç­”æ¡ˆï¼šæ”€çˆ¬ç¹©ï¼**

**è§£æ±ºæ–¹æ³•ï¼š** å¿«é€Ÿç”¨ç¹©å­æŠŠæ‰€æœ‰äº”åéšŠå“¡ç¶åœ¨ä¸€èµ·ã€‚å¦‚æœå¯èƒ½çš„è©±ï¼Œç”¨å‰©é¤˜çš„ç¹©å­æŠŠè‡ªå·±å›ºå®šåœ¨ä¸€å¡Šå¤§è€Œç©©å®šçš„å²©çŸ³ä¸Šã€‚

**ç§‘ï¿½ï¿½ï¿½åŸç†ï¼š** åœ¨ä½é‡åŠ›ç’°å¢ƒä¸‹ï¼Œåœ°éœ‡æœŸé–“å¾ˆå®¹æ˜“å¾åœ°é¢ã€Œå½ˆèµ·ã€ã€‚æŠŠåœ˜éšŠç¶åœ¨ä¸€èµ·ï¼Œä½ å€‘å°±å½¢æˆäº†ä¸€å€‹æ›´å¤§ã€æ›´é‡çš„ã€ŒéŒ¨ã€ï¼Œå¯ä»¥é˜²æ­¢ä»»ä½•äººæ‰é€²è£‚ç¸«æˆ–åœ¨æ··äº‚ä¸­é£„èµ°ã€‚

<div class="event-card-question"><span class="event-card-question-num">1</span><span>**åœ˜éšŠåˆä½œ**ï¼šç¶åœ¨ä¸€èµ·çš„åœ˜éšŠå°±åƒä¸€å€‹æ›´å¤§çš„ã€ŒéŒ¨ã€ï¼Œæ›´é›£è¢«éœ‡å‹•ã€‚</span></div>
<div class="event-card-question"><span class="event-card-question-num">2</span><span>**é˜²æ­¢åˆ†æ•£**ï¼šä½é‡åŠ›ä¸‹å®¹æ˜“å½ˆèµ·ï¼Œç¹©å­å¯ä»¥é˜²æ­¢éšŠå“¡é£„èµ°ã€‚</span></div>
<div class="event-card-question"><span class="event-card-question-num">3</span><span>**å®‰å…¨ä¿éšœ**ï¼šå¦‚æœæœ‰äººå¤±å»å¹³è¡¡ï¼Œå…¶ä»–äººå¯ä»¥æ‹‰ä½ä»–ï¼</span></div>`
        }
      ],
      en: [
        {
          id: 1,
          title: "ğŸƒâ€â™‚ï¸ The Invisible Wall",
          image: "https://pfst.cf2.poecdn.net/base/image/6080844d122a1145b6e5d111d894e0fbdbc71a58aad396afae02f03a61cf2815?w=1024&h=1536",
          situation: "You are sliding toward a cliff! How will you push back?",
          event: "On the Moon, you have the same 'mass' as on Earth, but there is no air to slow you down. Even though you feel light, your body acts like a heavy truck that is very hard to stop once it starts moving.",
          questions: [
            "If there is no wind to blow against you, why does your body keep zooming forward?"
          ],
          itemQuestion: "Which tool should you use to create 'thrust' to save yourself from the edge?",
          correctItem: "CO2 Fire Extinguisher",
          wrongItems: ["15m Climbing Rope", "Portable Heating Unit"],
          howToSolve: "Point the nozzle of the fire extinguisher away from the cliff (in front of you) and pull the handle to spray the gas.",
          explanation: `ğŸ§¯ **Correct Answer: CO2 Fire Extinguisher!**

**How to Solve:** Point the nozzle of the fire extinguisher away from the cliff (in front of you) and pull the handle to spray the gas.

**The Science:** This uses Newton's Third Law. When the gas shoots forward, it "kicks" your body backward with an equal force, helping you stop or change direction in a vacuum where there is no air to push against.

<div class="event-card-question"><span class="event-card-question-num">1</span><span>**Reaction Force**: When you spray gas forward, the gas creates a force that pushes you backward.</span></div>
<div class="event-card-question"><span class="event-card-question-num">2</span><span>**Overcoming Inertia**: This powerful thrust can cancel out your momentum towards the cliff and help you stop.</span></div>
<div class="event-card-question"><span class="event-card-question-num">3</span><span>**Space Science**: In places without air, this is the only way to change your direction of movement!</span></div>`
        },
        {
          id: 2,
          title: "ğŸ•³ï¸ The Hidden Skylight",
          image: "https://pfst.cf2.poecdn.net/base/image/c745dcb2496017d775da77744db8d39d8af0c4c0ac664d4f7ab2a04fcd7719d7?w=1024&h=1536",
          situation: "A giant hole leads underground. How will you enter safely?",
          event: "You found a giant 'skylight' leading to an underground lava tunnel. It is a perfect shelter from heat and radiation, but the drop is steep and dangerous. You must get your team down without anyone getting hurt.",
          questions: [
            "Why won't a parachute help you float down like it does on Earth?"
          ],
          itemQuestion: "Which tool should you use to help your team enter safely?",
          correctItem: "Shiny Silk Sheet",
          wrongItems: ["Inflatable Shelter", "First Aid Kit"],
          howToSolve: "Do not try to fly! Instead, use the tough fabric as a protective slide. Lay it over the sharp rocks and slide down, or use it to wrap supplies so they don't break when lowered.",
          explanation: `âœ¨ **Correct Answer: Shiny Silk Sheet!**

**How to Solve:** Do not try to fly! Instead, use the tough fabric as a protective slide. Lay it over the sharp rocks and slide down, or use it to wrap supplies so they don't break when lowered.

**The Science:** Parachutes don't work for "floating" on the Moon because there is no air to catch the fabric. However, nylon is very strong and light, making it a perfect tool to protect your suit from being torn by sharp, glass-like lunar rocks.

<div class="event-card-question"><span class="event-card-question-num">1</span><span>**No Air Resistance**: The Moon has no atmosphere, so parachutes cannot open to slow your descent.</span></div>
<div class="event-card-question"><span class="event-card-question-num">2</span><span>**Material Properties**: The silk fabric is tough and durable, protecting you from sharp rocks.</span></div>
<div class="event-card-question"><span class="event-card-question-num">3</span><span>**Creative Use**: The same tool can have different uses in different environments!</span></div>`
        },
        {
          id: 3,
          title: "ğŸ§­ The Magnet Mystery",
          image: "https://pfst.cf2.poecdn.net/base/image/41b2e1dd71c53dd9b73581f727098584f31206d94a6247b91f1cb3b07c1898e7?w=1024&h=1536",
          situation: "Your compass is broken! Use the stars to find home.",
          event: "You are lost on a flat plain and your electronic GPS has failed. On Earth, you would use a magnetic compass, but on the Moon, there is no magnetic 'North Pole' to move a needle. You must find your way back to base using the sky.",
          questions: [
            "Why can you see stars during the daytime on the Moon but not on Earth?"
          ],
          itemQuestion: "Which tool should you use to find direction?",
          correctItem: "Star Chart",
          wrongItems: ["Signal Mirror", "High-Power Binoculars"],
          howToSolve: "Hold the map up to the sky. Because there is no atmosphere to create a blue sky, the stars are visible even during the day. Use the constellations (patterns) to figure out which direction leads back to your ship.",
          explanation: `ğŸ—ºï¸ **Correct Answer: Star Chart!**

**How to Solve:** Hold the map up to the sky. Because there is no atmosphere to create a blue sky, the stars are visible even during the day. Use the constellations (patterns) to figure out which direction leads back to your ship.

**The Science:** The Moon has no global magnetic field, so a regular compass is useless. Since the stars never change position and there are no clouds to hide them, they are the most reliable "street signs" in space.

<div class="event-card-question"><span class="event-card-question-num">1</span><span>**No Magnetic Field**: The Moon doesn't have a magnetic field like Earth, so compasses don't work.</span></div>
<div class="event-card-question"><span class="event-card-question-num">2</span><span>**No Atmosphere**: Without air to scatter sunlight, stars are visible even during the day.</span></div>
<div class="event-card-question"><span class="event-card-question-num">3</span><span>**Stellar Navigation**: Star positions are fixed, making them the most reliable navigation tool in space!</span></div>`
        },
        {
          id: 4,
          title: "ğŸŒ€ The Moon 'Quake'",
          image: "https://pfst.cf2.poecdn.net/base/image/28a0f297f5562b3c46cc326ba59ff3664a7d76a9d6a5a21c2e674cdb7e730805?w=1024&h=1536",
          situation: "The ground is shaking! How will you stay together?",
          event: "The ground beneath your boots is vibrating! The Moon shrinks as it cools, causing long-lasting 'Moonquakes.' In low gravity, even a small shake can make you lose your balance and drift away from your team.",
          questions: [
            "If the ground is moving, why is it safer to be tied to your friends than standing alone?"
          ],
          itemQuestion: "Which tool should you use to keep your team safe?",
          correctItem: "15m Climbing Rope",
          wrongItems: ["Inflatable Shelter", "Drinking Water (20 Liters)"],
          howToSolve: "Quickly tie all five team members together using the rope. Use the remaining length to anchor yourselves to a large, stable rock if possible.",
          explanation: `ğŸª¢ **Correct Answer: 15m Climbing Rope!**

**How to Solve:** Quickly tie all five team members together using the rope. Use the remaining length to anchor yourselves to a large, stable rock if possible.

**The Science:** In low gravity, it is easy to "bounce" off the surface during a quake. By tying the team together, you create a larger, heavier "anchor" that prevents any one person from falling into a crack or drifting away in the confusion.

<div class="event-card-question"><span class="event-card-question-num">1</span><span>**Teamwork**: A tied-together team acts like a bigger "anchor" that's harder to shake loose.</span></div>
<div class="event-card-question"><span class="event-card-question-num">2</span><span>**Prevent Drifting**: In low gravity, you can easily bounce off - the rope keeps everyone together.</span></div>
<div class="event-card-question"><span class="event-card-question-num">3</span><span>**Safety Net**: If someone loses balance, others can pull them back!</span></div>`
        }
      ]
    };

    // Get current items based on language
    function getItems() {
      return itemsData[currentLang];
    }

    // Get current event cards based on language
    function getEventCards() {
      return eventCardsData[currentLang];
    }

    // Get translation
    function t(key) {
      return translations[currentLang][key] || key;
    }

    // Items and event cards are now stored in itemsData and eventCardsData above
    // Use getItems() and getEventCards() to access them based on current language

    let shuffledEvents = []; // å„²å­˜éš¨æ©Ÿæ’åºå¾Œçš„äº‹ä»¶å¡

    let playerRanking = [];
    let currentIncidentIndex = 0;
    let gamePhase = 'intro';
    let isProcessing = false;

    if (window.matchMedia?.('(prefers-color-scheme: dark)').matches) {
      document.documentElement.classList.add('dark');
    }
    window.matchMedia('(prefers-color-scheme: dark)').addEventListener('change', e => {
      document.documentElement.classList.toggle('dark', e.matches);
    });

    function createStars() {
      const container = document.getElementById('stars');
      for (let i = 0; i < 80; i++) {
        const star = document.createElement('div');
        star.className = 'star';
        star.style.cssText = `left:${Math.random()*100}%;top:${Math.random()*100}%;width:${Math.random()*3+1}px;height:${star.style.width};animation-delay:${Math.random()*2}s;`;
        container.appendChild(star);
      }
    }

    function shuffleArray(arr) {
      const a = [...arr];
      for (let i = a.length - 1; i > 0; i--) {
        const j = Math.floor(Math.random() * (i + 1));
        [a[i], a[j]] = [a[j], a[i]];
      }
      return a;
    }

    function showScreen(id) {
      document.querySelectorAll('.screen').forEach(s => s.classList.remove('active'));
      document.getElementById(id).classList.add('active');

      // Show/hide home button
      const homeBtn = document.getElementById('home-btn');
      if (id === 'intro-screen' || id === 'lang-screen') {
        homeBtn.style.display = 'none';
      } else {
        homeBtn.style.display = 'flex';
      }
    }

    function goHome() {
      location.reload();
    }

    // Language selection and UI update
    function selectLanguage(lang) {
      currentLang = lang;
      updateUILanguage();
      showScreen('intro-screen');
    }

    function updateUILanguage() {
      // Update header
      document.getElementById('main-title').textContent = t('title');
      document.getElementById('main-subtitle').textContent = t('subtitle');

      // Update intro screen
      document.getElementById('story-title').textContent = t('storyTitle');
      document.getElementById('story-content').innerHTML = t('storyContent');
      document.getElementById('intro-instructions').innerHTML = t('instructions');
      document.getElementById('intro-instructions-sub').textContent = t('instructionsSub');
      document.getElementById('start-btn').textContent = t('startBtn');

      // Update ranking screen
      document.getElementById('drag-instruction').textContent = t('dragInstruction');
      document.getElementById('submit-btn').textContent = t('submitBtn');

      // Update home button
      document.getElementById('home-btn').innerHTML = t('homeBtn');
    }

    function startRanking() {
      playerRanking = shuffleArray([...getItems()]);
      renderItems();
      showScreen('ranking-screen');
      gamePhase = 'ranking';
    }

    let sortable = null;

    function renderItems() {
      const c = document.getElementById('items-list');
      c.innerHTML = '';
      playerRanking.forEach((item, i) => {
        const el = document.createElement('div');
        el.className = 'item';
        el.dataset.id = item.id;

        el.innerHTML = `
          <div class="item-rank">${i+1}</div>
          <div class="item-emoji">${item.emoji}</div>
          <div class="item-name">${item.name}</div>
          <div class="item-drag-handle">â˜°</div>
        `;

        c.appendChild(el);
      });

      // Initialize SortableJS for easy drag-and-drop
      if (sortable) {
        sortable.destroy();
      }

      sortable = new Sortable(c, {
        animation: 200,
        easing: "cubic-bezier(0.25, 1, 0.5, 1)",
        ghostClass: 'sortable-ghost',
        chosenClass: 'sortable-chosen',
        dragClass: 'sortable-drag',
        handle: '.item', // Allow dragging from anywhere on the item
        delay: 100, // Small delay to prevent accidental drags
        delayOnTouchOnly: true, // Only apply delay on touch devices
        touchStartThreshold: 5, // Pixels to move before drag starts on touch
        forceFallback: true, // Better cross-browser support
        fallbackTolerance: 3,
        onEnd: function(evt) {
          // Update playerRanking array after drag ends
          const movedItem = playerRanking.splice(evt.oldIndex, 1)[0];
          playerRanking.splice(evt.newIndex, 0, movedItem);

          // Update rank numbers
          updateRankNumbers();
        }
      });
    }

    function updateRankNumbers() {
      const items = document.querySelectorAll('#items-list .item');
      items.forEach((item, i) => {
        const rankEl = item.querySelector('.item-rank');
        if (rankEl) {
          rankEl.textContent = i + 1;
        }
      });
    }

    function addMsg(content, type = 'bot', isHTML = false) {
      const m = document.getElementById('messages');
      const msg = document.createElement('div');
      msg.className = `message ${type}`;
      const sender = type === 'incident' ? t('senderIncident') : type === 'lesson' ? t('senderLesson') : t('senderBot');
      if (type !== 'user') {
        msg.innerHTML = `<div class="sender">${sender}</div><div class="message-content">${isHTML ? content : marked.parse(content)}</div>`;
      } else {
        msg.innerHTML = `<div class="message-content">${content}</div>`;
      }
      m.appendChild(msg);
      m.scrollTop = m.scrollHeight;
    }

    function showTyping() {
      const m = document.getElementById('messages');
      const typingEl = document.createElement('div');
      typingEl.className = 'message bot';
      typingEl.id = 'typing';
      typingEl.innerHTML = `<div class="sender">${t('senderBot')}</div><div class="typing-indicator"><div class="typing-dot"></div><div class="typing-dot"></div><div class="typing-dot"></div></div>`;
      m.appendChild(typingEl);
      m.scrollTop = m.scrollHeight;
    }

    function hideTyping() { document.getElementById('typing')?.remove(); }

    function setReplies(replies) {
      const c = document.getElementById('quick-replies');
      c.innerHTML = '';
      replies.forEach(r => {
        const btn = document.createElement('button');
        btn.className = `quick-reply ${r.className || ''} ${r.primary ? 'primary' : ''} ${r.warning ? 'warning' : ''}`;
        btn.innerHTML = r.html || r.text;
        btn.onclick = () => handleReply(r.value);
        c.appendChild(btn);
      });
    }

    function clearReplies() { document.getElementById('quick-replies').innerHTML = ''; }

    async function botSay(msg, isHTML = false, delay = 600) {
      showTyping();
      await new Promise(r => setTimeout(r, delay));
      hideTyping();
      addMsg(msg, 'bot', isHTML);
    }

    async function submitRankings() {
      showScreen('chat-screen');
      gamePhase = 'incidents';
      currentIncidentIndex = 0;

      // éš¨æ©Ÿæ’åºäº‹ä»¶å¡
      shuffledEvents = shuffleArray([...getEventCards()]);

      await botSay(t('rankingReceived'));

      await new Promise(r => setTimeout(r, 800));
      await showEventCard(0);
    }

    async function showEventCard(idx) {
      if (idx >= shuffledEvents.length) {
        await showResults();
        return;
      }

      const card = shuffledEvents[idx];
      currentIncidentIndex = idx;

      await new Promise(r => setTimeout(r, 300));
      addEventCard(card, idx + 1);

      await new Promise(r => setTimeout(r, 600));
      await botSay(`**ğŸ¯ ${card.itemQuestion}**`);

      showItemChoices(card);
    }

    function showItemChoices(card) {
      const c = document.getElementById('quick-replies');
      c.innerHTML = '';

      // Build choices array: 1 correct + 2 wrong
      const currentItems = getItems();
      const correctItemData = currentItems.find(i => i.name === card.correctItem);
      const wrongItemsData = card.wrongItems.map(name => currentItems.find(i => i.name === name));

      const allChoices = [
        { ...correctItemData, isCorrect: true },
        ...wrongItemsData.map(item => ({ ...item, isCorrect: false }))
      ];

      // Shuffle the 3 choices
      const shuffledChoices = shuffleArray(allChoices);

      shuffledChoices.forEach((choice, i) => {
        const btn = document.createElement('button');
        btn.className = 'quick-reply choice-btn';
        btn.innerHTML = `<span class="choice-letter">${String.fromCharCode(65 + i)}</span> <span class="choice-emoji">${choice.emoji}</span> ${choice.name}`;
        btn.onclick = () => handleItemAnswer(choice, card);
        c.appendChild(btn);
      });
    }

    async function handleItemAnswer(choice, card) {
      if (isProcessing) return;
      isProcessing = true;
      clearReplies();

      // Show user's choice
      addMsg(`${choice.emoji} ${choice.name}`, 'user');

      await new Promise(r => setTimeout(r, 400));

      if (choice.isCorrect) {
        const feedback = `<div class="feedback-correct" style="padding:12px;border-radius:12px;margin:5px 0">
          <strong>${t('correctFeedback')}</strong>
        </div>`;
        await botSay(feedback, true);
      } else {
        const feedback = `<div class="feedback-wrong" style="padding:12px;border-radius:12px;margin:5px 0">
          <strong>${t('wrongFeedback')}</strong>
        </div>`;
        await botSay(feedback, true);
      }

      await new Promise(r => setTimeout(r, 500));
      await botSay(card.explanation);

      await new Promise(r => setTimeout(r, 400));
      showNextBtn();

      isProcessing = false;
    }

    function addEventCard(card, displayNum) {
      const m = document.getElementById('messages');
      const msg = document.createElement('div');
      msg.className = 'message event-card';

      let questionsHTML = '';
      card.questions.forEach((q, i) => {
        questionsHTML += `
          <div class="event-card-question">
            <span class="event-card-question-num">${i + 1}</span>
            <span>${q}</span>
          </div>
        `;
      });

      // Create image HTML if image exists
      let imageHTML = '';
      if (card.image) {
        imageHTML = `
          <div class="event-card-image">
            <img src="${card.image}" alt="${card.title}" />
          </div>
        `;
      }

      msg.innerHTML = `
        <div class="event-card-header">
          <span class="event-card-badge">${t('eventCardLabel')} ${displayNum}/4</span>
        </div>
        <div class="event-card-title">${card.title}</div>

        ${imageHTML}

        <div class="event-card-section situation">
          <div class="event-card-section-title">${t('situationLabel')}</div>
          <div>${card.situation}</div>
        </div>

        <div class="event-card-section event">
          <div class="event-card-section-title">${t('eventLabel')}</div>
          <div>${card.event}</div>
        </div>

        <div class="event-card-section questions">
          <div class="event-card-section-title">${t('questionsLabel')}</div>
          ${questionsHTML}
        </div>
      `;

      m.appendChild(msg);
      m.scrollTop = m.scrollHeight;
    }

    async function handleReply(val) {
      if (isProcessing) return;
      isProcessing = true;
      clearReplies();

      if (val === 'next') {
        await showEventCard(currentIncidentIndex + 1);
      } else if (val === 'results') {
        await showResults();
      } else if (val === 'show_nasa') {
        await showNASAAnswer();
      } else if (val === 'restart') {
        location.reload();
      } else if (val.startsWith('explain_')) {
        const rank = parseInt(val.split('_')[1]);
        await explainItem(rank);
      }

      isProcessing = false;
    }

    function showNextBtn() {
      if (currentIncidentIndex < shuffledEvents.length - 1) {
        setReplies([{ text: t('nextCardBtn'), value: "next", primary: true }]);
      } else {
        setReplies([{ text: t('viewResultsBtn'), value: "results", primary: true }]);
      }
    }

    async function showResults() {
      gamePhase = 'results';

      await botSay(t('congratsMsg'));

      let totalDiff = 0;
      const results = [];
      playerRanking.forEach((item, i) => {
        const pRank = i + 1;
        const diff = Math.abs(pRank - item.nasaRank);
        totalDiff += diff;
        results.push({ ...item, playerRank: pRank, diff });
      });

      let badge, badgeClass;
      if (totalDiff <= 20) { badge = t('badgeExpert'); badgeClass = "gold"; }
      else if (totalDiff <= 40) { badge = t('badgeGood'); badgeClass = "silver"; }
      else { badge = t('badgeNovice'); badgeClass = "bronze"; }

      const scoreCard = `<div class="score-card"><div class="score-label">${t('scoreLabel')}</div><div class="score-number">${totalDiff}</div><div style="opacity:0.7;font-size:0.8rem">${t('scoreTip')}</div><div class="badge ${badgeClass}">${badge}</div></div>`;
      await botSay(scoreCard, true, 800);

      let table = `<table class="results-table"><tr><th>${t('tableItem')}</th><th>${t('tableYou')}</th><th>${t('tableNasa')}</th><th>${t('tableDiff')}</th></tr>`;
      results.forEach(item => {
        const dc = item.diff === 0 ? 'diff-good' : item.diff <= 3 ? 'diff-ok' : 'diff-bad';
        table += `<tr><td>${item.emoji} ${item.name}</td><td>${item.playerRank}</td><td>${item.nasaRank}</td><td class="${dc}">${item.diff === 0 ? 'âœ“' : item.diff}</td></tr>`;
      });
      table += '</table>';
      await botSay(table, true, 400);

      // é¡¯ç¤º NASA æ¨™æº–ç­”æ¡ˆæŒ‰éˆ•
      await botSay(t('nasaQuestion'));

      setReplies([
        { text: t('viewNasaBtn'), value: "show_nasa", primary: true },
        { text: t('restartBtn'), value: "restart" }
      ]);
    }

    async function showNASAAnswer() {
      await botSay(t('nasaTitle'));

      // ç²å–æ’åºå¾Œçš„ç‰©å“
      const currentItems = getItems();
      const sortedItems = [...currentItems].filter(i => i.nasaRank <= 15).sort((a, b) => a.nasaRank - b.nasaRank);

      let nasaTable = `<div style="background:linear-gradient(145deg, rgba(168,85,247,0.2), rgba(78,205,196,0.15)); border:3px solid var(--cosmic-purple); border-radius:16px; padding:16px; margin:10px 0;">
        <div style="text-align:center; margin-bottom:12px;">
          <span style="font-size:1.5rem;">ğŸ›ï¸</span>
          <strong style="color:var(--moon-yellow); font-size:1.1rem;"> ${t('nasaOfficialTitle')}</strong>
        </div>
        <table class="results-table" style="margin:0;">
          <tr><th style="width:15%">${t('tableRank')}</th><th>${t('tableItem')}</th><th style="width:55%">${t('tableReason')}</th></tr>`;

      sortedItems.forEach(item => {
        let rankStyle = '';
        if (item.nasaRank <= 3) {
          rankStyle = 'background:linear-gradient(135deg,#ffd700,#ffb700);color:#333;font-weight:900;';
        } else if (item.nasaRank <= 7) {
          rankStyle = 'background:linear-gradient(135deg,var(--alien-green),var(--star-blue));color:#333;font-weight:700;';
        } else if (item.nasaRank <= 10) {
          rankStyle = 'background:rgba(255,255,255,0.2);';
        } else {
          rankStyle = 'background:rgba(255,107,107,0.2);';
        }

        nasaTable += `<tr>
          <td style="${rankStyle};border-radius:8px;"><strong>#${item.nasaRank}</strong></td>
          <td><span style="font-size:1.2rem;">${item.emoji}</span> ${item.name}</td>
          <td style="text-align:left;font-size:0.75rem;line-height:1.4;">${item.reason}</td>
        </tr>`;
      });

      nasaTable += `</table></div>`;
      await botSay(nasaTable, true, 600);

      // ç¸½çµé‡é»
      await botSay(t('learningSummary'));

      await new Promise(r => setTimeout(r, 500));

      const items1 = getItems();
      setReplies([
        { text: `ğŸ›¢ï¸ ${t('learnMore')}${items1[0].name}`, value: "explain_1" },
        { text: `ğŸ”­ ${t('learnMore')}${items1[13].name}`, value: "explain_14" },
        { text: `ğŸ” ${t('learnMore')}${items1[14].name}`, value: "explain_15" },
        { text: t('restartBtn'), value: "restart", primary: true }
      ]);
    }

    async function explainItem(rank) {
      const currentItems = getItems();
      const item = currentItems.find(i => i.nasaRank === rank);
      if (item) {
        const rankText = currentLang === 'zh' ? `NASA æ’ç¬¬ ${item.nasaRank}` : `NASA Rank #${item.nasaRank}`;
        await botSay(`**${item.emoji} ${item.name} (${rankText})**\n\n${item.reason}`);
      }
      setReplies([
        { text: `ğŸ›¢ï¸ ${currentItems[0].name}`, value: "explain_1" },
        { text: `ğŸ’§ ${currentItems[1].name}`, value: "explain_2" },
        { text: `ğŸ—ºï¸ ${currentItems[2].name}`, value: "explain_3" },
        { text: `ğŸ”­ ${currentItems[13].name}`, value: "explain_14" },
        { text: `ğŸ” ${currentItems[14].name}`, value: "explain_15" },
        { text: t('restartBtn'), value: "restart", primary: true }
      ]);
    }

    createStars();
  </script>
</body>
</html>
